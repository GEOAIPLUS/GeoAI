<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GeoAI - AI-Powered Mapping & Navigation</title>

    <!-- Libraries -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --primary: #6366f1;
            --primary-hover: #4f46e5;
            --secondary: #8b5cf6;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --dark: #1e293b;
            --bg-glass: rgba(255, 255, 255, 0.92);
            --bg-dark-glass: rgba(30, 41, 59, 0.95);
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.15);
            --shadow-lg: 0 10px 40px rgba(0, 0, 0, 0.2);
            --radius: 16px;
            --radius-sm: 10px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: 'Inter', sans-serif; 
            overflow: hidden; 
            background: #f1f5f9;
            -webkit-tap-highlight-color: transparent;
        }
        
        #map { 
            height: 100vh; 
            width: 100%; 
            z-index: 1; 
        }

        /* ===== MODERN HEADER BAR ===== */
        .header-bar {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 70px;
            background: var(--bg-dark-glass);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 1000;
            display: flex;
            align-items: center;
            padding: 0 20px;
            gap: 20px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            color: white;
            font-size: 20px;
            font-weight: 700;
            letter-spacing: -0.5px;
            margin-right: 20px;
        }

        .logo i {
            font-size: 28px;
            color: var(--primary);
        }

        .header-spacer {
            flex: 1;
        }

        /* ===== SERVICE SEARCH BUTTONS ===== */
        .service-btns {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .service-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.15);
            color: rgba(255, 255, 255, 0.8);
            padding: 10px 16px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .service-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            transform: translateY(-1px);
        }

        .service-btn.active {
            background: var(--success);
            border-color: var(--success);
            color: white;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }

        .service-btn i {
            font-size: 16px;
        }

        /* Combined Search Dropdown */
        .combined-search-wrapper {
            position: relative;
        }

        .combined-search-btn {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 10px 16px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.2s;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
        }

        .combined-search-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(99, 102, 241, 0.5);
        }

        .combined-search-btn i {
            font-size: 16px;
        }

        .dropdown-menu {
            position: absolute;
            top: calc(100% + 8px);
            left: 0;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            padding: 12px;
            min-width: 280px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 10000;
        }

        .dropdown-menu.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .dropdown-header {
            padding: 8px 12px;
            border-bottom: 2px solid #f1f5f9;
            margin-bottom: 8px;
        }

        .dropdown-title {
            font-size: 13px;
            font-weight: 700;
            color: var(--dark);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .dropdown-item {
            display: flex;
            align-items: center;
            padding: 10px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 4px;
        }

        .dropdown-item:hover {
            background: #f8fafc;
        }

        .dropdown-item.all-services {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border: 2px solid #e2e8f0;
            font-weight: 600;
            margin-bottom: 12px;
        }

        .dropdown-item.all-services:hover {
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
        }

        .dropdown-checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid #cbd5e1;
            border-radius: 6px;
            margin-right: 12px;
            display: grid;
            place-items: center;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .dropdown-item.checked .dropdown-checkbox {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            border-color: #6366f1;
        }

        .dropdown-checkbox i {
            color: white;
            font-size: 12px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .dropdown-item.checked .dropdown-checkbox i {
            opacity: 1;
        }

        .dropdown-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: grid;
            place-items: center;
            margin-right: 12px;
            flex-shrink: 0;
        }

        .dropdown-icon i {
            font-size: 16px;
            color: white;
        }

        .icon-hotel { background: #0ea5e9; }
        .icon-restaurant { background: #f59e0b; }
        .icon-cafe { background: #92400e; }
        .icon-hospital { background: #10b981; }
        .icon-pharmacy { background: #06b6d4; }

        .dropdown-label {
            flex: 1;
            font-size: 14px;
            font-weight: 500;
            color: var(--dark);
        }

        .dropdown-footer {
            border-top: 1px solid #f1f5f9;
            margin-top: 8px;
            padding-top: 12px;
            display: flex;
            gap: 8px;
        }

        .dropdown-action-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-search {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .btn-search:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 16px rgba(99, 102, 241, 0.4);
        }

        .btn-clear {
            background: #f1f5f9;
            color: #64748b;
        }

        .btn-clear:hover {
            background: #e2e8f0;
            color: var(--dark);
        }

        /* ===== DRAWING MEASUREMENTS ===== */
        .draw-measurement-label {
            background: rgba(30, 41, 59, 0.95);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            pointer-events: none;
            white-space: nowrap;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            border: 2px solid rgba(255, 255, 255, 0.2);
            z-index: 1000;
        }

        .measurement-value {
            color: #10b981;
            font-size: 15px;
        }

        .measurement-unit {
            color: rgba(255, 255, 255, 0.8);
            font-size: 12px;
            margin-left: 4px;
        }

        /* Dimension line styles */
        .dimension-line {
            stroke: #6366f1;
            stroke-width: 2;
            stroke-dasharray: 5, 5;
            fill: none;
        }

        .dimension-endpoint {
            fill: #6366f1;
            stroke: white;
            stroke-width: 2;
        }

        /* Radius arc for circles */
        .radius-line {
            stroke: #10b981;
            stroke-width: 3;
            stroke-dasharray: 8, 4;
            fill: none;
        }

        .radius-endpoint {
            fill: #10b981;
            stroke: white;
            stroke-width: 2;
        }

        /* ===== AI ASSISTANT ===== */
        .ai-assistant-toggle {
            position: absolute;
            bottom: 30px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 14px;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            border: none;
            box-shadow: var(--shadow-md);
            color: white;
            font-size: 20px;
            cursor: pointer;
            display: grid;
            place-items: center;
            transition: all 0.3s;
            z-index: 998;
            animation: pulse-ai 2s infinite;
        }

        @keyframes pulse-ai {
            0%, 100% {
                box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
            }
            50% {
                box-shadow: 0 4px 20px rgba(99, 102, 241, 0.6);
            }
        }

        .ai-assistant-toggle:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 8px 24px rgba(99, 102, 241, 0.5);
        }

        .ai-assistant-toggle.active {
            background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
        }

        .ai-assistant-panel {
            position: absolute;
            bottom: 100px;
            right: 20px;
            width: 400px;
            height: 550px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            opacity: 0;
            visibility: hidden;
            transform: translateY(20px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 999;
        }

        .ai-assistant-panel.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .ai-header {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            padding: 20px;
            border-radius: 20px 20px 0 0;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .ai-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 16px;
            font-weight: 700;
        }

        .ai-title i {
            font-size: 20px;
        }

        .ai-status {
            font-size: 11px;
            opacity: 0.9;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .status-dot {
            width: 6px;
            height: 6px;
            background: #10b981;
            border-radius: 50%;
            animation: blink 2s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .ai-minimize {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 8px;
            cursor: pointer;
            display: grid;
            place-items: center;
            transition: all 0.2s;
        }

        .ai-minimize:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .ai-quick-actions {
            padding: 12px;
            border-bottom: 1px solid #f1f5f9;
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .quick-action-btn {
            padding: 6px 12px;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 500;
            color: var(--dark);
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .quick-action-btn:hover {
            background: #e0e7ff;
            border-color: var(--primary);
            color: var(--primary);
        }

        .ai-chat-area {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            background: #fafbfc;
        }

        .ai-message {
            margin-bottom: 16px;
            display: flex;
            gap: 10px;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .ai-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            flex-shrink: 0;
            display: grid;
            place-items: center;
            font-size: 14px;
        }

        .ai-avatar.bot {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
        }

        .ai-avatar.user {
            background: #e0e7ff;
            color: var(--primary);
        }

        .ai-message-content {
            flex: 1;
            background: white;
            padding: 12px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            font-size: 13px;
            line-height: 1.5;
        }

        .ai-message.user .ai-message-content {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
        }

        .ai-typing {
            display: flex;
            gap: 4px;
            padding: 8px 0;
        }

        .ai-typing span {
            width: 6px;
            height: 6px;
            background: #94a3b8;
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }

        .ai-typing span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .ai-typing span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
            }
            30% {
                transform: translateY(-10px);
            }
        }

        .ai-source-link {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            color: #6366f1;
            font-size: 11px;
            margin-top: 6px;
            text-decoration: none;
            font-weight: 500;
        }

        .ai-source-link:hover {
            text-decoration: underline;
        }

        .ai-action-buttons {
            display: flex;
            gap: 6px;
            margin-top: 8px;
        }

        .ai-action-btn {
            padding: 6px 12px;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .ai-action-btn:hover {
            background: #6366f1;
            color: white;
            border-color: #6366f1;
        }

        .ai-input-area {
            padding: 16px;
            border-top: 1px solid #f1f5f9;
            background: white;
            border-radius: 0 0 20px 20px;
        }

        .ai-input-container {
            display: flex;
            gap: 8px;
        }

        .ai-input {
            flex: 1;
            padding: 12px;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            font-size: 13px;
            font-family: 'Inter', sans-serif;
            transition: all 0.2s;
        }

        .ai-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .ai-send-btn {
            width: 44px;
            height: 44px;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .ai-send-btn:hover {
            transform: scale(1.05);
        }

        .ai-send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .ai-context-info {
            font-size: 11px;
            color: #94a3b8;
            padding: 8px 12px;
            background: #f8fafc;
            border-radius: 8px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* Chat scrollbar */
        .ai-chat-area::-webkit-scrollbar {
            width: 6px;
        }

        .ai-chat-area::-webkit-scrollbar-track {
            background: transparent;
        }

        .ai-chat-area::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        .ai-chat-area::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        .service-divider {
            width: 1px;
            height: 30px;
            background: rgba(255, 255, 255, 0.15);
            margin: 0 4px;
        }

        /* ===== SEARCH BAR ===== */
        .search-wrapper {
            position: relative;
            margin-left: 12px;
        }

        .search-input-container {
            position: relative;
            display: flex;
            align-items: center;
        }

        .search-input {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.15);
            color: white;
            padding: 10px 40px 10px 16px;
            border-radius: var(--radius-sm);
            font-size: 13px;
            font-weight: 500;
            width: 280px;
            transition: all 0.2s;
            font-family: 'Inter', sans-serif;
        }

        .search-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .search-input:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.15);
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }

        .search-btn-icon {
            position: absolute;
            right: 12px;
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.6);
            cursor: pointer;
            font-size: 16px;
            transition: all 0.2s;
            padding: 4px;
        }

        .search-btn-icon:hover {
            color: white;
            transform: scale(1.1);
        }

        .search-results {
            position: absolute;
            top: calc(100% + 8px);
            left: 0;
            right: 0;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            max-height: 300px;
            overflow-y: auto;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 10001;
        }

        .search-results.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .search-result-item {
            padding: 12px 16px;
            border-bottom: 1px solid #f1f5f9;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        .search-result-item:hover {
            background: #f8fafc;
        }

        .search-result-icon {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            border-radius: 8px;
            display: grid;
            place-items: center;
            flex-shrink: 0;
        }

        .search-result-icon i {
            color: white;
            font-size: 16px;
        }

        .search-result-content {
            flex: 1;
            min-width: 0;
        }

        .search-result-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 2px;
        }

        .search-result-address {
            font-size: 12px;
            color: #64748b;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .search-loading {
            padding: 20px;
            text-align: center;
            color: #64748b;
            font-size: 13px;
        }

        .search-no-results {
            padding: 20px;
            text-align: center;
            color: #94a3b8;
            font-size: 13px;
        }

        /* ===== MARK LOCATION BUTTON ===== */
        .mark-location-btn {
            position: absolute;
            bottom: 340px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 14px;
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            border: none;
            box-shadow: var(--shadow-md);
            color: white;
            font-size: 20px;
            cursor: pointer;
            display: grid;
            place-items: center;
            transition: all 0.2s;
            z-index: 998;
        }

        .mark-location-btn:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 8px 20px rgba(239, 68, 68, 0.4);
        }

        .mark-location-btn:active {
            transform: scale(0.95);
        }

        .mark-location-btn.active {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            animation: pulse-mark 1.5s infinite;
        }

        @keyframes pulse-mark {
            0%, 100% {
                box-shadow: 0 4px 12px rgba(220, 38, 38, 0.5);
            }
            50% {
                box-shadow: 0 4px 24px rgba(220, 38, 38, 0.7);
            }
        }

        /* Marker info popup */
        .marker-info-popup {
            position: absolute;
            bottom: 330px;
            right: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            padding: 16px;
            width: 260px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(10px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 999;
        }

        .marker-info-popup.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .marker-info-title {
            font-size: 13px;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 8px;
        }

        .marker-info-text {
            font-size: 12px;
            color: #64748b;
            line-height: 1.5;
            margin-bottom: 12px;
        }

        .marker-info-actions {
            display: flex;
            gap: 8px;
        }

        .marker-info-btn {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-set-start {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .btn-set-start:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .btn-cancel-mark {
            background: #f1f5f9;
            color: #64748b;
        }

        .btn-cancel-mark:hover {
            background: #e2e8f0;
            color: var(--dark);
        }

        /* ===== NAVIGATION MODE ===== */
        .navigation-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .navigation-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .nav-header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 80px;
            background: linear-gradient(180deg, rgba(0, 0, 0, 0.8) 0%, transparent 100%);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px;
            z-index: 2001;
        }

        .nav-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .nav-eta {
            color: white;
            font-size: 32px;
            font-weight: 700;
        }

        .nav-distance {
            color: rgba(255, 255, 255, 0.8);
            font-size: 18px;
            font-weight: 500;
        }

        .nav-exit-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-exit-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.05);
        }

        .nav-instruction-panel {
            position: absolute;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            padding: 24px 32px;
            min-width: 400px;
            max-width: 600px;
            z-index: 2001;
        }

        .nav-current-instruction {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 16px;
        }

        .nav-maneuver-icon {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            border-radius: 16px;
            display: grid;
            place-items: center;
            flex-shrink: 0;
        }

        .nav-maneuver-icon i {
            font-size: 28px;
            color: white;
        }

        .nav-instruction-text {
            flex: 1;
        }

        .nav-instruction-main {
            font-size: 20px;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 4px;
        }

        .nav-instruction-distance {
            font-size: 14px;
            color: #64748b;
        }

        .nav-next-steps {
            border-top: 1px solid #f1f5f9;
            padding-top: 16px;
        }

        .nav-next-step {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 0;
            font-size: 13px;
            color: #64748b;
        }

        .nav-next-step i {
            font-size: 16px;
            width: 24px;
            text-align: center;
        }

        .nav-progress-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: #f1f5f9;
            border-radius: 0 0 20px 20px;
            overflow: hidden;
        }

        .nav-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981 0%, #059669 100%);
            transition: width 0.3s;
        }

        /* Transport Layer Toggle */
        .transport-layer-controls {
            position: absolute;
            top: 100px;
            right: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            padding: 12px;
            z-index: 997;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .transport-layer-controls.show {
            opacity: 1;
            visibility: visible;
        }

        .transport-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 4px;
        }

        .transport-toggle:hover {
            background: #f8fafc;
        }

        .transport-toggle.active {
            background: #f1f5f9;
        }

        .transport-checkbox {
            width: 18px;
            height: 18px;
            border: 2px solid #cbd5e1;
            border-radius: 4px;
            display: grid;
            place-items: center;
            transition: all 0.2s;
        }

        .transport-toggle.active .transport-checkbox {
            background: var(--primary);
            border-color: var(--primary);
        }

        .transport-checkbox i {
            color: white;
            font-size: 10px;
            opacity: 0;
        }

        .transport-toggle.active .transport-checkbox i {
            opacity: 1;
        }

        .transport-label {
            font-size: 13px;
            font-weight: 500;
            color: var(--dark);
        }

        /* Start Navigation Button in Route Panel */
        .start-nav-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            margin-top: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.2s;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .start-nav-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(16, 185, 129, 0.4);
        }

        .start-nav-btn i {
            font-size: 18px;
        }

        /* ===== ROUTING HISTORY ===== */
        .history-button {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 56px;
            height: 56px;
            border-radius: 16px;
            background: white;
            border: none;
            box-shadow: var(--shadow-md);
            color: var(--dark);
            font-size: 20px;
            cursor: pointer;
            display: grid;
            place-items: center;
            transition: all 0.2s;
            z-index: 1001;
        }

        .history-button:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
            color: var(--primary);
        }

        .history-button .badge {
            position: absolute;
            top: -6px;
            right: -6px;
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            font-size: 11px;
            font-weight: 700;
            display: grid;
            place-items: center;
            border: 2px solid white;
        }

        .history-panel {
            position: absolute;
            top: 0;
            right: 0;
            width: 420px;
            height: 100vh;
            background: var(--bg-glass);
            backdrop-filter: blur(20px);
            box-shadow: var(--shadow-lg);
            border-left: 1px solid rgba(0, 0, 0, 0.08);
            z-index: 1002;
            display: flex;
            flex-direction: column;
            opacity: 0;
            visibility: hidden;
            transform: translateX(100%);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .history-panel.show {
            opacity: 1;
            visibility: visible;
            transform: translateX(0);
        }

        .history-header {
            padding: 24px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.08);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .history-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .history-title i {
            color: var(--primary);
            font-size: 22px;
        }

        .history-header-actions {
            display: flex;
            gap: 8px;
        }

        .close-history-btn {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            background: #f1f5f9;
            border: none;
            color: #64748b;
            cursor: pointer;
            display: grid;
            place-items: center;
            font-size: 16px;
            transition: all 0.2s;
        }

        .close-history-btn:hover {
            background: #e2e8f0;
            color: var(--dark);
        }

        .clear-history-btn {
            background: transparent;
            border: 1px solid var(--danger);
            color: var(--danger);
            padding: 8px 14px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.2s;
        }

        .clear-history-btn:hover {
            background: var(--danger);
            color: white;
        }

        .history-list {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
        }

        .history-item {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            border: 1px solid rgba(0, 0, 0, 0.08);
            cursor: pointer;
            transition: all 0.2s;
        }

        .history-item:hover {
            box-shadow: var(--shadow-sm);
            transform: translateY(-2px);
            border-color: var(--primary);
        }

        .history-item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .history-date {
            font-size: 11px;
            color: #94a3b8;
            font-weight: 500;
        }

        .history-mode-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            display: grid;
            place-items: center;
            color: white;
            font-size: 14px;
        }

        .history-route {
            margin-bottom: 12px;
        }

        .history-location {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            margin-bottom: 8px;
            font-size: 13px;
        }

        .history-location i {
            margin-top: 2px;
            flex-shrink: 0;
        }

        .location-from i {
            color: #ef4444;
        }

        .location-to i {
            color: #10b981;
        }

        .location-text {
            flex: 1;
            color: var(--dark);
            font-weight: 500;
            line-height: 1.4;
        }

        .history-stats {
            display: flex;
            gap: 16px;
            padding-top: 12px;
            border-top: 1px solid #f1f5f9;
        }

        .history-stat {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: #64748b;
        }

        .history-stat i {
            font-size: 14px;
        }

        .history-stat strong {
            color: var(--dark);
            font-weight: 600;
        }

        .history-empty {
            text-align: center;
            padding: 60px 20px;
            color: #94a3b8;
        }

        .history-empty i {
            font-size: 48px;
            margin-bottom: 16px;
            display: block;
            opacity: 0.5;
        }

        .history-empty-text {
            font-size: 14px;
            line-height: 1.6;
        }

        /* History Detail View */
        .history-detail {
            display: none;
            padding: 16px;
            background: #f8fafc;
            border-radius: 8px;
            margin-top: 12px;
        }

        .history-item.expanded .history-detail {
            display: block;
        }

        .detail-title {
            font-size: 12px;
            font-weight: 700;
            color: var(--dark);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }

        .detail-step {
            display: flex;
            gap: 10px;
            padding: 8px 0;
            border-bottom: 1px solid #e2e8f0;
            font-size: 12px;
        }

        .detail-step:last-child {
            border-bottom: none;
        }

        .detail-step-number {
            width: 24px;
            height: 24px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: grid;
            place-items: center;
            font-size: 11px;
            font-weight: 700;
            flex-shrink: 0;
        }

        .detail-step-content {
            flex: 1;
            padding-top: 2px;
        }

        .detail-step-name {
            color: var(--dark);
            font-weight: 500;
            margin-bottom: 2px;
        }

        .detail-step-distance {
            color: #64748b;
            font-size: 11px;
        }

        .history-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .history-action-btn {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .btn-replay {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
        }

        .btn-replay:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .btn-delete {
            background: #f1f5f9;
            color: #64748b;
        }

        .btn-delete:hover {
            background: var(--danger);
            color: white;
        }

        .service-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .service-btn.active {
            background: var(--success);
            border-color: var(--success);
            color: white;
        }

        /* ===== LEFT SIDEBAR - DRAW TOOLS ===== */
        .draw-tools-panel {
            position: absolute;
            top: 90px;
            left: 20px;
            width: 70px;
            background: var(--bg-glass);
            backdrop-filter: blur(20px);
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            border: 1px solid rgba(0, 0, 0, 0.08);
            z-index: 999;
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .draw-tool-btn {
            width: 46px;
            height: 46px;
            border: 1px solid rgba(0, 0, 0, 0.08);
            background: white;
            border-radius: 12px;
            cursor: pointer;
            display: grid;
            place-items: center;
            color: #64748b;
            font-size: 18px;
            transition: all 0.2s;
            position: relative;
        }

        .draw-tool-btn:hover {
            background: #f8fafc;
            color: var(--primary);
            transform: scale(1.05);
            box-shadow: var(--shadow-sm);
        }

        .draw-tool-btn.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
        }

        .tool-divider {
            height: 1px;
            background: rgba(0, 0, 0, 0.08);
            margin: 4px 0;
        }

        .draw-tool-btn .tooltip {
            position: absolute;
            left: 100%;
            top: 50%;
            transform: translateY(-50%);
            margin-left: 12px;
            background: var(--bg-dark-glass);
            color: white;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 500;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            z-index: 10000;
        }

        .draw-tool-btn:hover .tooltip {
            opacity: 1;
        }

        /* ===== MAP LAYERS PANEL ===== */
        .layers-panel {
            position: absolute;
            top: 90px;
            left: 110px;
            width: 200px;
            background: var(--bg-glass);
            backdrop-filter: blur(20px);
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            border: 1px solid rgba(0, 0, 0, 0.08);
            z-index: 998;
            overflow: hidden;
        }

        .panel-header {
            padding: 12px 16px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.08);
        }

        .panel-title {
            font-size: 13px;
            font-weight: 700;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .panel-title i {
            color: var(--primary);
            font-size: 14px;
        }

        .layers-list {
            padding: 10px;
        }

        .layer-item {
            background: white;
            border: 1px solid rgba(0, 0, 0, 0.08);
            border-radius: 10px;
            padding: 10px 12px;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .layer-item:hover {
            box-shadow: var(--shadow-sm);
            border-color: var(--primary);
        }

        .layer-item.active {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            border-color: var(--primary);
            color: white;
        }

        .layer-radio {
            width: 16px;
            height: 16px;
            border: 2px solid #cbd5e1;
            border-radius: 50%;
            flex-shrink: 0;
            position: relative;
            transition: all 0.2s;
        }

        .layer-item.active .layer-radio {
            border-color: white;
        }

        .layer-radio::after {
            content: '';
            position: absolute;
            width: 6px;
            height: 6px;
            background: white;
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            transition: transform 0.2s;
        }

        .layer-item.active .layer-radio::after {
            transform: translate(-50%, -50%) scale(1);
        }

        .layer-info {
            flex: 1;
            min-width: 0;
        }

        .layer-name {
            font-size: 12px;
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 2px;
        }

        .layer-item.active .layer-name {
            color: white;
        }

        .layer-meta {
            font-size: 10px;
            color: #64748b;
        }

        .layer-item.active .layer-meta {
            color: rgba(255, 255, 255, 0.8);
        }

        .layer-icon {
            font-size: 16px;
            color: #94a3b8;
        }

        .layer-item.active .layer-icon {
            color: white;
        }

        /* ===== BOTTOM CONTROLS ===== */
        .bottom-controls {
            position: absolute;
            bottom: 100px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 997;
        }

        .fab {
            width: 50px;
            height: 50px;
            border-radius: 14px;
            background: white;
            border: none;
            box-shadow: var(--shadow-md);
            color: var(--dark);
            font-size: 18px;
            cursor: pointer;
            display: grid;
            place-items: center;
            transition: all 0.2s;
        }

        .fab:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
            color: var(--primary);
        }

        .fab:active {
            transform: scale(0.95);
        }

        .fab.primary {
            background: var(--primary);
            color: white;
        }

        .fab.primary:hover {
            background: var(--primary-hover);
        }

        /* ===== ROUTE PANEL ===== */
        .route-panel {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%) translateY(150%);
            width: 90%;
            max-width: 500px;
            background: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            z-index: 1100;
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            max-height: 70vh;
            display: flex;
            flex-direction: column;
        }

        .route-panel.active {
            transform: translateX(-50%) translateY(0);
        }

        .route-header {
            padding: 20px;
            border-bottom: 1px solid #f1f5f9;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .route-stats {
            display: flex;
            gap: 16px;
            align-items: baseline;
        }

        .time-large {
            font-size: 32px;
            font-weight: 700;
            color: var(--primary);
        }

        .dist-info {
            font-size: 14px;
            color: #64748b;
            font-weight: 500;
        }

        .close-route {
            width: 32px;
            height: 32px;
            border: none;
            background: #f1f5f9;
            border-radius: 8px;
            cursor: pointer;
            color: #64748b;
            display: grid;
            place-items: center;
            transition: all 0.2s;
        }

        .close-route:hover {
            background: #e2e8f0;
            color: var(--dark);
        }

        .mode-selector {
            display: flex;
            gap: 8px;
            padding: 0 20px 16px;
            border-bottom: 1px solid #f1f5f9;
        }

        .mode-btn {
            flex: 1;
            padding: 10px;
            border: 1px solid #e2e8f0;
            background: white;
            border-radius: 10px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            color: #64748b;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .mode-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .mode-btn.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        .route-steps {
            flex: 1;
            overflow-y: auto;
            padding: 16px 20px;
        }

        .step-item {
            display: flex;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid #f8fafc;
            font-size: 14px;
        }

        .step-item:last-child {
            border-bottom: none;
        }

        .step-icon {
            width: 24px;
            color: var(--primary);
            text-align: center;
        }

        .step-content {
            flex: 1;
        }

        .step-distance {
            color: #94a3b8;
            font-size: 12px;
        }

        /* ===== TOAST NOTIFICATION ===== */
        .toast {
            position: fixed;
            top: 90px;
            left: 50%;
            transform: translateX(-50%) translateY(-20px);
            background: var(--bg-dark-glass);
            backdrop-filter: blur(20px);
            color: white;
            padding: 14px 24px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 500;
            box-shadow: var(--shadow-lg);
            z-index: 9999;
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        /* ===== CUSTOM LEAFLET CONTROLS ===== */
        .leaflet-control-layers {
            display: none !important;
        }

        /* ===== SCROLLBAR STYLING ===== */
        .layers-list::-webkit-scrollbar,
        .route-steps::-webkit-scrollbar {
            width: 6px;
        }

        .layers-list::-webkit-scrollbar-track,
        .route-steps::-webkit-scrollbar-track {
            background: transparent;
        }

        .layers-list::-webkit-scrollbar-thumb,
        .route-steps::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }

        .layers-list::-webkit-scrollbar-thumb:hover,
        .route-steps::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* ===== RESPONSIVE DESIGN ===== */
        @media (max-width: 768px) {
            .header-bar {
                padding: 0 12px;
                height: 60px;
            }

            .logo span {
                display: none;
            }

            .service-btns {
                gap: 4px;
            }

            .service-btn span {
                display: none;
            }

            .service-btn {
                padding: 8px 12px;
            }

            .draw-tools-panel {
                width: 60px;
                padding: 8px;
            }

            .draw-tool-btn {
                width: 44px;
                height: 44px;
            }

            .layers-panel {
                width: calc(100% - 140px);
                max-width: 180px;
            }

            .route-panel {
                width: calc(100% - 40px);
            }

            .history-panel {
                width: 100%;
            }

            .history-button {
                top: 10px;
                right: 10px;
            }

            .ai-assistant-panel {
                width: calc(100% - 40px);
                right: 20px;
                left: 20px;
                bottom: 80px;
                height: 450px;
            }

            .ai-assistant-toggle {
                right: 20px;
                bottom: 20px;
                width: 46px;
                height: 46px;
            }

            .bottom-controls {
                bottom: 80px;
                right: 20px;
            }

            .fab {
                width: 46px;
                height: 46px;
                font-size: 16px;
            }

            .mark-location-btn {
                width: 46px;
                height: 46px;
                font-size: 18px;
                bottom: 300px;
            }
        }

        /* ===== CUSTOM MAP MARKERS ===== */
        .custom-marker {
            background: var(--primary);
            width: 32px;
            height: 32px;
            border-radius: 50% 50% 50% 0;
            transform: rotate(-45deg);
            border: 3px solid white;
            box-shadow: var(--shadow-md);
        }

        .custom-marker::after {
            content: '';
            position: absolute;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
        }

        /* Custom Leaflet Div Icons */
        .map-pin {
            position: relative;
            width: 40px;
            height: 50px;
        }

        .pin-background {
            position: absolute;
            width: 40px;
            height: 40px;
            background: white;
            border-radius: 50% 50% 50% 0;
            transform: rotate(-45deg);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            border: 3px solid white;
        }

        .pin-icon {
            position: absolute;
            top: 8px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 18px;
            z-index: 10;
            color: white;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        /* Service-specific colors */
        .pin-hotel .pin-background { background: #0ea5e9; }
        .pin-restaurant .pin-background { background: #f59e0b; }
        .pin-cafe .pin-background { background: #92400e; }
        .pin-hospital .pin-background { background: #10b981; }
        .pin-pharmacy .pin-background { background: #06b6d4; }

        /* Pulse animation for active markers */
        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
            }
            70% {
                box-shadow: 0 0 0 15px rgba(239, 68, 68, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
            }
        }

        .pin-background.pulse {
            animation: pulse 2s infinite;
        }
    </style>
</head>
<body>

    <!-- HEADER BAR -->
    <div class="header-bar">
        <div class="logo">
            <i class="fas fa-globe"></i>
            <span>GeoAI</span>
        </div>

        <!-- SERVICE SEARCH BUTTONS (Moved to left) -->
        <div class="service-btns">
            <button class="service-btn" onclick="app.searchService('hotel')">
                <i class="fas fa-bed"></i> <span>Hotels</span>
            </button>
            <button class="service-btn" onclick="app.searchService('restaurant')">
                <i class="fas fa-utensils"></i> <span>Restaurants</span>
            </button>
            <button class="service-btn" onclick="app.searchService('cafe')">
                <i class="fas fa-coffee"></i> <span>Cafes</span>
            </button>
            <button class="service-btn" onclick="app.searchService('hospital')">
                <i class="fas fa-hospital-alt"></i> <span>Hospitals</span>
            </button>
            
            <div class="service-divider"></div>
            
            <!-- Combined Search Dropdown -->
            <div class="combined-search-wrapper">
                <button class="combined-search-btn" onclick="app.toggleCombinedSearch()">
                    <i class="fas fa-layer-group"></i> 
                    <span>Combined Search</span>
                    <i class="fas fa-chevron-down" style="font-size: 11px;"></i>
                </button>
                
                <div class="dropdown-menu" id="combined-dropdown">
                    <div class="dropdown-header">
                        <div class="dropdown-title">Select Services</div>
                    </div>
                    
                    <!-- All Services Option -->
                    <div class="dropdown-item all-services" onclick="app.toggleAllServices(this)">
                        <div class="dropdown-checkbox">
                            <i class="fas fa-check"></i>
                        </div>
                        <div class="dropdown-label">All Services</div>
                    </div>
                    
                    <!-- Individual Services -->
                    <div class="dropdown-item" data-service="hotel" onclick="app.toggleService(this, 'hotel')">
                        <div class="dropdown-checkbox">
                            <i class="fas fa-check"></i>
                        </div>
                        <div class="dropdown-icon icon-hotel">
                            <i class="fas fa-bed"></i>
                        </div>
                        <div class="dropdown-label">Hotels</div>
                    </div>
                    
                    <div class="dropdown-item" data-service="restaurant" onclick="app.toggleService(this, 'restaurant')">
                        <div class="dropdown-checkbox">
                            <i class="fas fa-check"></i>
                        </div>
                        <div class="dropdown-icon icon-restaurant">
                            <i class="fas fa-utensils"></i>
                        </div>
                        <div class="dropdown-label">Restaurants</div>
                    </div>
                    
                    <div class="dropdown-item" data-service="cafe" onclick="app.toggleService(this, 'cafe')">
                        <div class="dropdown-checkbox">
                            <i class="fas fa-check"></i>
                        </div>
                        <div class="dropdown-icon icon-cafe">
                            <i class="fas fa-coffee"></i>
                        </div>
                        <div class="dropdown-label">Cafes</div>
                    </div>
                    
                    <div class="dropdown-item" data-service="hospital" onclick="app.toggleService(this, 'hospital')">
                        <div class="dropdown-checkbox">
                            <i class="fas fa-check"></i>
                        </div>
                        <div class="dropdown-icon icon-hospital">
                            <i class="fas fa-hospital-alt"></i>
                        </div>
                        <div class="dropdown-label">Hospitals</div>
                    </div>
                    
                    <div class="dropdown-item" data-service="pharmacy" onclick="app.toggleService(this, 'pharmacy')">
                        <div class="dropdown-checkbox">
                            <i class="fas fa-check"></i>
                        </div>
                        <div class="dropdown-icon icon-pharmacy">
                            <i class="fas fa-pills"></i>
                        </div>
                        <div class="dropdown-label">Pharmacies</div>
                    </div>
                    
                    <!-- Footer Actions -->
                    <div class="dropdown-footer">
                        <button class="dropdown-action-btn btn-clear" onclick="app.clearServiceSelection()">
                            Clear
                        </button>
                        <button class="dropdown-action-btn btn-search" onclick="app.searchCombinedServices()">
                            <i class="fas fa-search"></i> Search
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Search Bar -->
            <div class="search-wrapper">
                <div class="search-input-container">
                    <input 
                        type="text" 
                        class="search-input" 
                        id="location-search" 
                        placeholder="Search for a place or address..."
                        onkeypress="if(event.key==='Enter') app.searchLocation()"
                    />
                    <button class="search-btn-icon" onclick="app.searchLocation()">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
                
                <div class="search-results" id="search-results">
                    <!-- Results will be populated here -->
                </div>
            </div>
        </div>

        <div class="header-spacer"></div>
    </div>

    <!-- MAP -->
    <div id="map"></div>

    <!-- LEFT SIDEBAR - DRAW TOOLS -->
    <div class="draw-tools-panel">
        <button class="draw-tool-btn" onclick="app.activateTool('polygon')" data-tool="polygon">
            <i class="fas fa-draw-polygon"></i>
            <span class="tooltip">Polygon</span>
        </button>
        <button class="draw-tool-btn" onclick="app.activateTool('rectangle')" data-tool="rectangle">
            <i class="fas fa-vector-square"></i>
            <span class="tooltip">Rectangle</span>
        </button>
        <button class="draw-tool-btn" onclick="app.activateTool('circle')" data-tool="circle">
            <i class="fas fa-circle"></i>
            <span class="tooltip">Circle</span>
        </button>
        <button class="draw-tool-btn" onclick="app.activateTool('polyline')" data-tool="polyline">
            <i class="fas fa-route"></i>
            <span class="tooltip">Polyline</span>
        </button>
        <button class="draw-tool-btn" onclick="app.activateTool('marker')" data-tool="marker">
            <i class="fas fa-map-marker-alt"></i>
            <span class="tooltip">Marker</span>
        </button>
        
        <div class="tool-divider"></div>
        
        <button class="draw-tool-btn" onclick="app.deleteLastShape()">
            <i class="fas fa-trash-alt"></i>
            <span class="tooltip">Delete Last</span>
        </button>
        <button class="draw-tool-btn" onclick="app.clearAllShapes()">
            <i class="fas fa-trash"></i>
            <span class="tooltip">Clear All</span>
        </button>
    </div>

    <!-- MAP LAYERS PANEL -->
    <div class="layers-panel">
        <div class="panel-header">
            <div class="panel-title">
                <i class="fas fa-map"></i>
                Map Layers
            </div>
        </div>
        <div class="layers-list">
            <div class="layer-item active" onclick="app.switchMapLayer('street', this)">
                <div class="layer-radio"></div>
                <div class="layer-info">
                    <div class="layer-name">Street Map</div>
                    <div class="layer-meta">Default view</div>
                </div>
                <i class="fas fa-map layer-icon"></i>
            </div>
            <div class="layer-item" onclick="app.switchMapLayer('satellite', this)">
                <div class="layer-radio"></div>
                <div class="layer-info">
                    <div class="layer-name">Satellite</div>
                    <div class="layer-meta">Aerial imagery</div>
                </div>
                <i class="fas fa-satellite layer-icon"></i>
            </div>
            <div class="layer-item" onclick="app.switchMapLayer('hybrid', this)">
                <div class="layer-radio"></div>
                <div class="layer-info">
                    <div class="layer-name">Hybrid</div>
                    <div class="layer-meta">Satellite + labels</div>
                </div>
                <i class="fas fa-layer-group layer-icon"></i>
            </div>
            <div class="layer-item" onclick="app.switchMapLayer('terrain', this)">
                <div class="layer-radio"></div>
                <div class="layer-info">
                    <div class="layer-name">Terrain</div>
                    <div class="layer-meta">Topographic view</div>
                </div>
                <i class="fas fa-mountain layer-icon"></i>
            </div>
        </div>
    </div>

    <!-- TRANSPORT LAYER CONTROLS -->
    <div class="transport-layer-controls" id="transport-controls">
        <div class="transport-toggle active" onclick="app.toggleTransportLayer('roads')">
            <div class="transport-checkbox">
                <i class="fas fa-check"></i>
            </div>
            <div class="transport-label">Roads & Traffic</div>
        </div>
        <div class="transport-toggle" onclick="app.toggleTransportLayer('transit')">
            <div class="transport-checkbox">
                <i class="fas fa-check"></i>
            </div>
            <div class="transport-label">Public Transit</div>
        </div>
        <div class="transport-toggle" onclick="app.toggleTransportLayer('bike')">
            <div class="transport-checkbox">
                <i class="fas fa-check"></i>
            </div>
            <div class="transport-label">Bike Paths</div>
        </div>
    </div>

    <!-- ROUTING HISTORY BUTTON -->
    <button class="history-button" onclick="app.toggleHistory()" title="Routing History">
        <i class="fas fa-history"></i>
        <span class="badge" id="history-count">0</span>
    </button>

    <!-- ROUTING HISTORY PANEL -->
    <div class="history-panel" id="history-panel">
        <div class="history-header">
            <div class="history-title">
                <i class="fas fa-route"></i>
                Route History
            </div>
            <div class="history-header-actions">
                <button class="clear-history-btn" onclick="app.clearHistory()">
                    <i class="fas fa-trash-alt"></i> Clear All
                </button>
                <button class="close-history-btn" onclick="app.toggleHistory()" title="Close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        <div class="history-list" id="history-list">
            <div class="history-empty">
                <i class="fas fa-map-marked-alt"></i>
                <div class="history-empty-text">
                    No routing history yet.<br>
                    Start navigating to save your routes!
                </div>
            </div>
        </div>
    </div>

    <!-- MARK LOCATION BUTTON -->
    <button class="mark-location-btn" id="mark-location-btn" onclick="app.toggleMarkLocation()" title="Mark your starting point">
        <i class="fas fa-map-pin"></i>
    </button>

    <!-- Marker Info Popup -->
    <div class="marker-info-popup" id="marker-info-popup">
        <div class="marker-info-title">
            <i class="fas fa-info-circle"></i> Mark Starting Point
        </div>
        <div class="marker-info-text">
            Click anywhere on the map to set your starting point for directions.
        </div>
        <div class="marker-info-actions">
            <button class="marker-info-btn btn-cancel-mark" onclick="app.cancelMarkLocation()">
                Cancel
            </button>
        </div>
    </div>

    <!-- BOTTOM CONTROLS -->
    <div class="bottom-controls">
        <button class="fab" onclick="map.zoomIn()" title="Zoom In">
            <i class="fas fa-plus"></i>
        </button>
        <button class="fab" onclick="map.zoomOut()" title="Zoom Out">
            <i class="fas fa-minus"></i>
        </button>
        <button class="fab primary" onclick="app.locateUser()" title="My Location">
            <i class="fas fa-location-crosshairs"></i>
        </button>
    </div>

    <!-- ROUTE PANEL -->
    <div class="route-panel" id="route-panel">
        <div class="route-header">
            <div class="route-stats">
                <div class="time-large" id="route-time">--</div>
                <div class="dist-info" id="route-dist">-- km</div>
            </div>
            <button class="close-route" onclick="app.clearRoute()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="mode-selector">
            <button class="mode-btn active" onclick="app.switchMode('driving', this)">
                <i class="fas fa-car"></i> Drive
            </button>
            <button class="mode-btn" onclick="app.switchMode('walking', this)">
                <i class="fas fa-walking"></i> Walk
            </button>
            <button class="mode-btn" onclick="app.switchMode('cycling', this)">
                <i class="fas fa-bicycle"></i> Bike
            </button>
        </div>
        
        <div class="route-steps" id="route-steps">
            <!-- Steps will be populated here -->
        </div>

        <!-- Start Navigation Button -->
        <div style="padding: 0 20px 20px;">
            <button class="start-nav-btn" onclick="app.startNavigation()">
                <i class="fas fa-location-arrow"></i>
                Start Navigation
            </button>
        </div>
    </div>

    <!-- NAVIGATION OVERLAY -->
    <div class="navigation-overlay" id="nav-overlay">
        <div class="nav-header">
            <div class="nav-info">
                <div class="nav-eta" id="nav-eta">--</div>
                <div class="nav-distance" id="nav-distance">-- km remaining</div>
            </div>
            <button class="nav-exit-btn" onclick="app.exitNavigation()">
                <i class="fas fa-times"></i>
                Exit Navigation
            </button>
        </div>

        <div class="nav-instruction-panel">
            <div class="nav-current-instruction">
                <div class="nav-maneuver-icon">
                    <i class="fas fa-arrow-up" id="nav-maneuver-icon"></i>
                </div>
                <div class="nav-instruction-text">
                    <div class="nav-instruction-main" id="nav-instruction-main">
                        Calculating route...
                    </div>
                    <div class="nav-instruction-distance" id="nav-instruction-distance">
                        Preparing navigation
                    </div>
                </div>
            </div>

            <div class="nav-next-steps" id="nav-next-steps">
                <!-- Next steps will be populated here -->
            </div>

            <div class="nav-progress-bar">
                <div class="nav-progress-fill" id="nav-progress" style="width: 0%"></div>
            </div>
        </div>
    </div>

    <!-- AI ASSISTANT -->
    <button class="ai-assistant-toggle" id="ai-toggle" onclick="app.toggleAI()" title="AI Assistant">
        <i class="fas fa-robot"></i>
    </button>

    <div class="ai-assistant-panel" id="ai-panel">
        <div class="ai-header">
            <div>
                <div class="ai-title">
                    <i class="fas fa-robot"></i>
                    GeoAI Assistant
                </div>
                <div class="ai-status">
                    <span class="status-dot"></span>
                    Online
                </div>
            </div>
            <button class="ai-minimize" onclick="app.toggleAI()">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <div class="ai-quick-actions">
            <button class="quick-action-btn" onclick="app.quickAsk('compare hotels')">
                <i class="fas fa-hotel"></i> Compare Hotels
            </button>
            <button class="quick-action-btn" onclick="app.quickAsk('best restaurant')">
                <i class="fas fa-star"></i> Best Restaurant
            </button>
            <button class="quick-action-btn" onclick="app.quickAsk('quiet cafe')">
                <i class="fas fa-coffee"></i> Quiet Cafe
            </button>
            <button class="quick-action-btn" onclick="app.quickAsk('nearest hospital')">
                <i class="fas fa-hospital"></i> Nearest Hospital
            </button>
            <button class="quick-action-btn" onclick="app.quickAsk('24hr pharmacy')">
                <i class="fas fa-pills"></i> 24hr Pharmacy
            </button>
        </div>

        <div class="ai-chat-area" id="ai-chat">
            <div class="ai-context-info">
                <i class="fas fa-info-circle"></i>
                I can help you find and compare services on your map
            </div>
            <div class="ai-message">
                <div class="ai-avatar bot">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="ai-message-content">
                     Hi! I'm your GeoAI assistant. I can help you find the best hotels, restaurants, cafes, hospitals, and pharmacies by searching real information from Google Maps, Booking.com, and other trusted sources.
                    <br><br>
                    Try asking me:
                    <br> "Compare these 3 hotels"
                    <br> "Which restaurant has the best reviews?"
                    <br> "Find a quiet cafe with WiFi"
                    <br> "What's the nearest emergency room?"
                </div>
            </div>
        </div>

        <div class="ai-input-area">
            <div class="ai-input-container">
                <input 
                    type="text" 
                    class="ai-input" 
                    id="ai-input" 
                    placeholder="Ask me anything about nearby services..."
                    onkeypress="if(event.key==='Enter') app.sendAIMessage()"
                />
                <button class="ai-send-btn" onclick="app.sendAIMessage()" id="ai-send">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- TOAST NOTIFICATION -->
    <div class="toast" id="toast"></div>

    <!-- SCRIPTS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>

    <script>
        // ===== INITIALIZE MAP =====
        const map = L.map('map', {
            zoomControl: false,
            attributionControl: true
        }).setView([40.7128, -74.0060], 13);

        // Map tile layers
        const mapLayers = {
            street: L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                subdomains: 'abcd',
                maxZoom: 20
            }),
            satellite: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community',
                maxZoom: 20
            }),
            hybrid: L.layerGroup([
                L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                    maxZoom: 20
                }),
                L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager_only_labels/{z}/{x}/{y}{r}.png', {
                    maxZoom: 20,
                    subdomains: 'abcd'
                })
            ]),
            terrain: L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
                attribution: 'Map data: &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, <a href="http://viewfinderpanoramas.org">SRTM</a> | Map style: &copy; <a href="https://opentopomap.org">OpenTopoMap</a>',
                maxZoom: 17
            })
        };

        // Transport overlay layers
        const transportLayers = {
            roads: L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager_labels_under/{z}/{x}/{y}{r}.png', {
                subdomains: 'abcd',
                maxZoom: 20,
                opacity: 0.8
            }),
            transit: L.tileLayer('https://tile.thunderforest.com/transport/{z}/{x}/{y}.png?apikey=YOUR_API_KEY', {
                maxZoom: 20,
                opacity: 0.7
            }),
            bike: L.tileLayer('https://tiles.wmflabs.org/cyclosm/{z}/{x}/{y}.png', {
                maxZoom: 20,
                opacity: 0.7
            })
        };

        // Add default layer
        mapLayers.street.addTo(map);
        let currentMapLayer = 'street';
        let activeTransportLayers = ['roads'];

        // ===== APPLICATION STATE =====
        const app = {
            layers: {
                drawn: L.featureGroup().addTo(map),
                services: L.featureGroup().addTo(map),
                route: L.featureGroup().addTo(map),
                user: L.featureGroup().addTo(map)
            },
            
            state: {
                currentTool: null,
                drawHandler: null,
                layerCounter: 0,
                userLocation: null,
                routeDestination: null,
                routeMode: 'driving',
                colors: ['#6366f1', '#8b5cf6', '#ec4899', '#f59e0b', '#10b981', '#06b6d4', '#ef4444'],
                selectedServices: [],
                markedLocation: null,
                markingMode: false,
                searchResults: [],
                navigationActive: false,
                currentRoute: null,
                currentStepIndex: 0,
                navigationInterval: null,
                measurementMarkers: [],
                measurementLines: []
            },

            routingHistory: [],

            layerData: [],

            // ===== INITIALIZE =====
            init: function() {
                // Set up map events
                map.on('draw:created', (e) => this.onDrawCreated(e));
                map.on('click', (e) => this.onMapClick(e));
                
                // Initialize draw control (hidden)
                this.drawControl = new L.Control.Draw({
                    draw: false,
                    edit: false
                });
                
                // Close search results when clicking outside
                document.addEventListener('click', (e) => {
                    const searchWrapper = document.querySelector('.search-wrapper');
                    if (searchWrapper && !searchWrapper.contains(e.target)) {
                        document.getElementById('search-results').classList.remove('show');
                    }
                });

                // Load routing history from localStorage
                this.loadHistoryFromStorage();
                
                console.log('GeoAI initialized');
            },

            // ===== MAP CLICK HANDLER =====
            onMapClick: function(e) {
                if (this.state.markingMode) {
                    this.setMarkedLocation(e.latlng.lat, e.latlng.lng);
                }
            },

            // ===== LOCATION SEARCH =====
            searchLocation: async function() {
                const input = document.getElementById('location-search');
                const query = input.value.trim();
                
                if (!query) {
                    this.toast('Please enter a location to search');
                    return;
                }
                
                const resultsContainer = document.getElementById('search-results');
                resultsContainer.innerHTML = '<div class="search-loading"><i class="fas fa-spinner fa-spin"></i> Searching...</div>';
                resultsContainer.classList.add('show');
                
                try {
                    // Using Nominatim (OpenStreetMap) geocoding service
                    const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5`);
                    const data = await response.json();
                    
                    if (data.length === 0) {
                        resultsContainer.innerHTML = '<div class="search-no-results"><i class="fas fa-map-marker-slash"></i><br>No results found</div>';
                        return;
                    }
                    
                    // Display results
                    resultsContainer.innerHTML = data.map(result => `
                        <div class="search-result-item" onclick="app.selectSearchResult(${result.lat}, ${result.lon}, '${result.display_name.replace(/'/g, "\\'")}')">
                            <div class="search-result-icon">
                                <i class="fas fa-map-marker-alt"></i>
                            </div>
                            <div class="search-result-content">
                                <div class="search-result-name">${result.display_name.split(',')[0]}</div>
                                <div class="search-result-address">${result.display_name}</div>
                            </div>
                        </div>
                    `).join('');
                    
                } catch (error) {
                    console.error('Search error:', error);
                    resultsContainer.innerHTML = '<div class="search-no-results"><i class="fas fa-exclamation-triangle"></i><br>Search failed. Try again.</div>';
                }
            },

            selectSearchResult: function(lat, lng, name) {
                // Close search results
                document.getElementById('search-results').classList.remove('show');
                document.getElementById('location-search').value = '';
                
                // Fly to location
                map.flyTo([lat, lng], 15, {
                    duration: 1.5
                });
                
                // Show options to mark as starting point
                this.showMarkLocationDialog(lat, lng, name);
            },

            showMarkLocationDialog: function(lat, lng, name) {
                // Add temporary marker
                if (this.tempMarker) {
                    map.removeLayer(this.tempMarker);
                }
                
                const customIcon = L.divIcon({
                    className: 'custom-div-icon',
                    html: `
                        <div class="map-pin" style="transform: scale(1.2);">
                            <div class="pin-background" style="background: #f59e0b;"></div>
                            <i class="fas fa-map-pin pin-icon"></i>
                        </div>
                    `,
                    iconSize: [48, 60],
                    iconAnchor: [24, 54],
                    popupAnchor: [0, -54]
                });
                
                this.tempMarker = L.marker([lat, lng], { icon: customIcon }).addTo(map);
                
                this.tempMarker.bindPopup(`
                    <div style="text-align: center; padding: 12px; min-width: 220px;">
                        <div style="margin-bottom: 12px;">
                            <i class="fas fa-map-marked-alt" style="font-size: 28px; color: #f59e0b;"></i>
                        </div>
                        <strong style="font-size: 14px; color: #1e293b; display: block; margin-bottom: 12px;">
                            ${name.split(',').slice(0, 2).join(',')}
                        </strong>
                        <button onclick="app.setAsStartingPoint(${lat}, ${lng}, '${name.replace(/'/g, "\\'")}')" 
                        style="
                            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                            color: white;
                            border: none;
                            padding: 10px 20px;
                            border-radius: 10px;
                            cursor: pointer;
                            font-weight: 600;
                            font-size: 13px;
                            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
                            transition: all 0.2s;
                            width: 100%;
                            margin-bottom: 8px;
                        "
                        onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(16, 185, 129, 0.4)';"
                        onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(16, 185, 129, 0.3)';">
                            <i class="fas fa-thumbtack"></i> Set as Starting Point
                        </button>
                        <button onclick="app.removeTempMarker()" 
                        style="
                            background: #f1f5f9;
                            color: #64748b;
                            border: none;
                            padding: 8px 16px;
                            border-radius: 8px;
                            cursor: pointer;
                            font-weight: 600;
                            font-size: 12px;
                            width: 100%;
                        "
                        onmouseover="this.style.background='#e2e8f0';"
                        onmouseout="this.style.background='#f1f5f9';">
                            Cancel
                        </button>
                    </div>
                `).openPopup();
            },

            setAsStartingPoint: function(lat, lng, name) {
                this.state.markedLocation = { lat, lng, name };
                
                // Remove temp marker and add permanent one
                if (this.tempMarker) {
                    map.removeLayer(this.tempMarker);
                }
                
                // Clear previous marked location
                this.layers.user.clearLayers();
                
                // Add starting point marker
                const startIcon = L.divIcon({
                    className: 'custom-div-icon',
                    html: `
                        <div class="map-pin">
                            <div class="pin-background" style="background: #ef4444;"></div>
                            <i class="fas fa-flag-checkered pin-icon"></i>
                        </div>
                    `,
                    iconSize: [40, 50],
                    iconAnchor: [20, 45],
                    popupAnchor: [0, -45]
                });
                
                L.marker([lat, lng], { icon: startIcon })
                    .bindPopup(`
                        <div style="text-align: center; padding: 8px;">
                            <strong>Starting Point</strong><br>
                            <span style="font-size: 12px; color: #64748b;">${name.split(',').slice(0, 2).join(',')}</span>
                        </div>
                    `)
                    .addTo(this.layers.user);
                
                map.closePopup();
                this.toast('Starting point set! Search for services and get directions.');
            },

            removeTempMarker: function() {
                if (this.tempMarker) {
                    map.removeLayer(this.tempMarker);
                    this.tempMarker = null;
                }
                map.closePopup();
            },

            // ===== MARK LOCATION MODE =====
            toggleMarkLocation: function() {
                this.state.markingMode = !this.state.markingMode;
                const btn = document.getElementById('mark-location-btn');
                const popup = document.getElementById('marker-info-popup');
                
                if (this.state.markingMode) {
                    btn.classList.add('active');
                    popup.classList.add('show');
                    map.getContainer().style.cursor = 'crosshair';
                    this.toast('Click on the map to mark your starting point');
                } else {
                    btn.classList.remove('active');
                    popup.classList.remove('show');
                    map.getContainer().style.cursor = '';
                }
            },

            cancelMarkLocation: function() {
                this.state.markingMode = false;
                document.getElementById('mark-location-btn').classList.remove('active');
                document.getElementById('marker-info-popup').classList.remove('show');
                map.getContainer().style.cursor = '';
            },

            setMarkedLocation: function(lat, lng) {
                this.state.markingMode = false;
                document.getElementById('mark-location-btn').classList.remove('active');
                document.getElementById('marker-info-popup').classList.remove('show');
                map.getContainer().style.cursor = '';
                
                // Get location name via reverse geocoding
                this.reverseGeocode(lat, lng);
            },

            reverseGeocode: async function(lat, lng) {
                try {
                    const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`);
                    const data = await response.json();
                    const name = data.display_name || 'Marked Location';
                    
                    this.setAsStartingPoint(lat, lng, name);
                    
                } catch (error) {
                    console.error('Reverse geocoding error:', error);
                    this.setAsStartingPoint(lat, lng, 'Marked Location');
                }
            },

            // ===== MAP LAYER SWITCHING =====
            switchMapLayer: function(layerType, element) {
                // Remove current layer
                map.removeLayer(mapLayers[currentMapLayer]);
                
                // Add new layer
                mapLayers[layerType].addTo(map);
                currentMapLayer = layerType;
                
                // Update UI
                document.querySelectorAll('.layer-item').forEach(item => {
                    item.classList.remove('active');
                });
                element.classList.add('active');
                
                this.toast(`Switched to ${layerType} view`);
            },

            // ===== ACTIVATE DRAWING TOOL =====
            activateTool: function(tool) {
                // Deactivate current tool
                if (this.state.drawHandler) {
                    this.state.drawHandler.disable();
                }

                // Clear previous measurements
                this.clearMeasurements();

                // Update UI
                document.querySelectorAll('.draw-tool-btn').forEach(btn => btn.classList.remove('active'));
                event.currentTarget.classList.add('active');

                // Activate new tool
                this.state.currentTool = tool;
                
                switch(tool) {
                    case 'polygon':
                        this.state.drawHandler = new L.Draw.Polygon(map, {
                            shapeOptions: {
                                color: this.getNextColor(),
                                weight: 3,
                                opacity: 0.8,
                                fillOpacity: 0.3
                            }
                        });
                        this.setupPolygonMeasurement();
                        break;
                    case 'rectangle':
                        this.state.drawHandler = new L.Draw.Rectangle(map, {
                            shapeOptions: {
                                color: this.getNextColor(),
                                weight: 3,
                                opacity: 0.8,
                                fillOpacity: 0.3
                            }
                        });
                        this.setupRectangleMeasurement();
                        break;
                    case 'circle':
                        this.state.drawHandler = new L.Draw.Circle(map, {
                            shapeOptions: {
                                color: this.getNextColor(),
                                weight: 3,
                                opacity: 0.8,
                                fillOpacity: 0.3
                            }
                        });
                        this.setupCircleMeasurement();
                        break;
                    case 'polyline':
                        this.state.drawHandler = new L.Draw.Polyline(map, {
                            shapeOptions: {
                                color: this.getNextColor(),
                                weight: 4,
                                opacity: 0.8
                            }
                        });
                        break;
                    case 'marker':
                        this.state.drawHandler = new L.Draw.Marker(map);
                        break;
                }

                this.state.drawHandler.enable();
                this.toast(`Drawing ${tool}... Click on map to start`);
            },

            // ===== MEASUREMENT FUNCTIONS =====
            setupCircleMeasurement: function() {
                const self = this;
                
                map.on('draw:drawvertex', function(e) {
                    self.clearMeasurements();
                    
                    const layers = e.layers;
                    layers.eachLayer(function(layer) {
                        if (layer instanceof L.Circle) {
                            const center = layer.getLatLng();
                            const radius = layer.getRadius(); // in meters
                            
                            self.showCircleRadius(center, radius);
                        }
                    });
                });
            },

            setupRectangleMeasurement: function() {
                const self = this;
                
                map.on('draw:drawvertex', function(e) {
                    self.clearMeasurements();
                    
                    const layers = e.layers;
                    layers.eachLayer(function(layer) {
                        if (layer instanceof L.Rectangle) {
                            const bounds = layer.getBounds();
                            self.showRectangleDimensions(bounds);
                        }
                    });
                });
            },

            setupPolygonMeasurement: function() {
                const self = this;
                
                map.on('draw:drawvertex', function(e) {
                    self.clearMeasurements();
                    
                    const layers = e.layers;
                    layers.eachLayer(function(layer) {
                        if (layer instanceof L.Polygon && !(layer instanceof L.Rectangle)) {
                            const latlngs = layer.getLatLngs()[0];
                            if (latlngs && latlngs.length >= 2) {
                                self.showPolygonDimensions(latlngs);
                            }
                        }
                    });
                });
            },

            showCircleRadius: function(center, radius) {
                // Calculate point on circle edge (towards northeast)
                const angle = 45 * Math.PI / 180;
                const dx = radius * Math.cos(angle);
                const dy = radius * Math.sin(angle);
                
                // Convert meters to lat/lng offset
                const edgePoint = L.latLng(
                    center.lat + (dy / 111320),
                    center.lng + (dx / (111320 * Math.cos(center.lat * Math.PI / 180)))
                );

                // Create radius line
                const radiusLine = L.polyline([center, edgePoint], {
                    color: '#10b981',
                    weight: 3,
                    dashArray: '8, 4',
                    className: 'radius-line'
                }).addTo(map);

                this.state.measurementLines.push(radiusLine);

                // Add center point
                const centerMarker = L.circleMarker(center, {
                    radius: 5,
                    fillColor: '#10b981',
                    color: 'white',
                    weight: 2,
                    fillOpacity: 1
                }).addTo(map);

                this.state.measurementMarkers.push(centerMarker);

                // Add edge point
                const edgeMarker = L.circleMarker(edgePoint, {
                    radius: 5,
                    fillColor: '#10b981',
                    color: 'white',
                    weight: 2,
                    fillOpacity: 1
                }).addTo(map);

                this.state.measurementMarkers.push(edgeMarker);

                // Add label at midpoint
                const midLat = (center.lat + edgePoint.lat) / 2;
                const midLng = (center.lng + edgePoint.lng) / 2;

                const label = this.formatDistance(radius);
                const measurementLabel = L.marker([midLat, midLng], {
                    icon: L.divIcon({
                        className: 'draw-measurement-label',
                        html: `<div>Radius: <span class="measurement-value">${label.value}</span><span class="measurement-unit">${label.unit}</span></div>`,
                        iconSize: null,
                        iconAnchor: [60, 20]
                    })
                }).addTo(map);

                this.state.measurementMarkers.push(measurementLabel);
            },

            showRectangleDimensions: function(bounds) {
                const ne = bounds.getNorthEast();
                const sw = bounds.getSouthWest();
                const nw = L.latLng(ne.lat, sw.lng);
                const se = L.latLng(sw.lat, ne.lng);

                // Calculate width (horizontal distance at bottom)
                const width = this.calculateDistance(sw, se);
                
                // Calculate height (vertical distance at left)
                const height = this.calculateDistance(sw, nw);

                // Draw width dimension line (bottom)
                const widthMidLat = sw.lat;
                const widthMidLng = (sw.lng + se.lng) / 2;

                const widthLine = L.polyline([sw, se], {
                    color: '#6366f1',
                    weight: 2,
                    dashArray: '5, 5',
                    className: 'dimension-line'
                }).addTo(map);

                this.state.measurementLines.push(widthLine);

                // Width label
                const widthLabel = this.formatDistance(width);
                const widthMarker = L.marker([widthMidLat, widthMidLng], {
                    icon: L.divIcon({
                        className: 'draw-measurement-label',
                        html: `<div>Width: <span class="measurement-value">${widthLabel.value}</span><span class="measurement-unit">${widthLabel.unit}</span></div>`,
                        iconSize: null,
                        iconAnchor: [55, 30]
                    })
                }).addTo(map);

                this.state.measurementMarkers.push(widthMarker);

                // Draw height dimension line (left)
                const heightMidLat = (sw.lat + nw.lat) / 2;
                const heightMidLng = sw.lng;

                const heightLine = L.polyline([sw, nw], {
                    color: '#6366f1',
                    weight: 2,
                    dashArray: '5, 5',
                    className: 'dimension-line'
                }).addTo(map);

                this.state.measurementLines.push(heightLine);

                // Height label
                const heightLabel = this.formatDistance(height);
                const heightMarker = L.marker([heightMidLat, heightMidLng], {
                    icon: L.divIcon({
                        className: 'draw-measurement-label',
                        html: `<div>Length: <span class="measurement-value">${heightLabel.value}</span><span class="measurement-unit">${heightLabel.unit}</span></div>`,
                        iconSize: null,
                        iconAnchor: [60, -5]
                    })
                }).addTo(map);

                this.state.measurementMarkers.push(heightMarker);

                // Add corner markers
                [sw, se, nw, ne].forEach(point => {
                    const marker = L.circleMarker(point, {
                        radius: 4,
                        fillColor: '#6366f1',
                        color: 'white',
                        weight: 2,
                        fillOpacity: 1
                    }).addTo(map);
                    this.state.measurementMarkers.push(marker);
                });
            },

            showPolygonDimensions: function(latlngs) {
                // Show dimensions for each edge
                for (let i = 0; i < latlngs.length; i++) {
                    const start = latlngs[i];
                    const end = latlngs[(i + 1) % latlngs.length];
                    
                    if (!start || !end) continue;

                    const distance = this.calculateDistance(start, end);
                    
                    // Only show if edge is long enough (> 10 meters)
                    if (distance < 10) continue;

                    // Draw dimension line
                    const dimLine = L.polyline([start, end], {
                        color: '#6366f1',
                        weight: 2,
                        dashArray: '5, 5',
                        opacity: 0.7
                    }).addTo(map);

                    this.state.measurementLines.push(dimLine);

                    // Add label at midpoint
                    const midLat = (start.lat + end.lat) / 2;
                    const midLng = (start.lng + end.lng) / 2;

                    const label = this.formatDistance(distance);
                    const measurementLabel = L.marker([midLat, midLng], {
                        icon: L.divIcon({
                            className: 'draw-measurement-label',
                            html: `<div><span class="measurement-value">${label.value}</span><span class="measurement-unit">${label.unit}</span></div>`,
                            iconSize: null,
                            iconAnchor: [30, 20]
                        })
                    }).addTo(map);

                    this.state.measurementMarkers.push(measurementLabel);
                }

                // Add vertex markers
                latlngs.forEach(point => {
                    const marker = L.circleMarker(point, {
                        radius: 4,
                        fillColor: '#6366f1',
                        color: 'white',
                        weight: 2,
                        fillOpacity: 1
                    }).addTo(map);
                    this.state.measurementMarkers.push(marker);
                });
            },

            calculateDistance: function(latlng1, latlng2) {
                // Haversine formula for distance in meters
                const R = 6371000; // Earth's radius in meters
                const lat1 = latlng1.lat * Math.PI / 180;
                const lat2 = latlng2.lat * Math.PI / 180;
                const deltaLat = (latlng2.lat - latlng1.lat) * Math.PI / 180;
                const deltaLng = (latlng2.lng - latlng1.lng) * Math.PI / 180;

                const a = Math.sin(deltaLat / 2) * Math.sin(deltaLat / 2) +
                         Math.cos(lat1) * Math.cos(lat2) *
                         Math.sin(deltaLng / 2) * Math.sin(deltaLng / 2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

                return R * c; // Distance in meters
            },

            formatDistance: function(meters) {
                if (meters < 1000) {
                    return {
                        value: Math.round(meters),
                        unit: 'm'
                    };
                } else {
                    return {
                        value: (meters / 1000).toFixed(2),
                        unit: 'km'
                    };
                }
            },

            clearMeasurements: function() {
                // Remove all measurement markers
                this.state.measurementMarkers.forEach(marker => {
                    map.removeLayer(marker);
                });
                this.state.measurementMarkers = [];

                // Remove all measurement lines
                this.state.measurementLines.forEach(line => {
                    map.removeLayer(line);
                });
                this.state.measurementLines = [];
            },

            // ===== HANDLE DRAW CREATED =====
            onDrawCreated: function(e) {
                const layer = e.layer;
                const type = e.layerType;
                
                // Clear measurements when shape is completed
                this.clearMeasurements();
                
                // Add to map
                this.layers.drawn.addLayer(layer);
                
                // Create layer data
                const layerId = ++this.state.layerCounter;
                const color = layer.options.color || this.getNextColor();
                
                const layerInfo = {
                    id: layerId,
                    layer: layer,
                    type: type,
                    color: color,
                    name: `${type.charAt(0).toUpperCase() + type.slice(1)} ${layerId}`,
                    visible: true
                };
                
                this.layerData.push(layerInfo);
                
                // Deactivate tool
                document.querySelectorAll('.draw-tool-btn').forEach(btn => btn.classList.remove('active'));
                if (this.state.drawHandler) {
                    this.state.drawHandler.disable();
                }
                
                this.toast(`${type} added`);
            },

            // ===== SHAPE MANAGEMENT =====
            deleteLastShape: function() {
                if (this.layerData.length === 0) {
                    this.toast('No shapes to delete');
                    return;
                }
                
                const lastLayer = this.layerData[this.layerData.length - 1];
                this.layers.drawn.removeLayer(lastLayer.layer);
                this.layerData.pop();
                
                this.toast('Last shape deleted');
            },

            clearAllShapes: function() {
                if (this.layerData.length === 0) {
                    this.toast('No shapes to clear');
                    return;
                }
                
                if (confirm('Clear all shapes?')) {
                    this.layers.drawn.clearLayers();
                    this.layerData = [];
                    this.toast('All shapes cleared');
                }
            },

            // ===== COMBINED SEARCH DROPDOWN =====
            toggleCombinedSearch: function() {
                const dropdown = document.getElementById('combined-dropdown');
                dropdown.classList.toggle('show');
                
                // Close dropdown when clicking outside
                if (dropdown.classList.contains('show')) {
                    setTimeout(() => {
                        document.addEventListener('click', this.closeCombinedSearchOutside);
                    }, 100);
                } else {
                    document.removeEventListener('click', this.closeCombinedSearchOutside);
                }
            },

            closeCombinedSearchOutside: function(e) {
                const dropdown = document.getElementById('combined-dropdown');
                const wrapper = document.querySelector('.combined-search-wrapper');
                
                if (!wrapper.contains(e.target)) {
                    dropdown.classList.remove('show');
                    document.removeEventListener('click', app.closeCombinedSearchOutside);
                }
            },

            toggleService: function(element, service) {
                event.stopPropagation();
                element.classList.toggle('checked');
                
                if (element.classList.contains('checked')) {
                    if (!this.state.selectedServices.includes(service)) {
                        this.state.selectedServices.push(service);
                    }
                } else {
                    this.state.selectedServices = this.state.selectedServices.filter(s => s !== service);
                }
                
                // Update "All Services" checkbox
                this.updateAllServicesCheckbox();
            },

            toggleAllServices: function(element) {
                event.stopPropagation();
                const allItems = document.querySelectorAll('.dropdown-item[data-service]');
                
                if (element.classList.contains('checked')) {
                    // Uncheck all
                    element.classList.remove('checked');
                    allItems.forEach(item => item.classList.remove('checked'));
                    this.state.selectedServices = [];
                } else {
                    // Check all
                    element.classList.add('checked');
                    allItems.forEach(item => item.classList.add('checked'));
                    this.state.selectedServices = ['hotel', 'restaurant', 'cafe', 'hospital', 'pharmacy'];
                }
            },

            updateAllServicesCheckbox: function() {
                const allServicesItem = document.querySelector('.dropdown-item.all-services');
                const totalServices = 5;
                
                if (this.state.selectedServices.length === totalServices) {
                    allServicesItem.classList.add('checked');
                } else {
                    allServicesItem.classList.remove('checked');
                }
            },

            clearServiceSelection: function() {
                event.stopPropagation();
                this.state.selectedServices = [];
                document.querySelectorAll('.dropdown-item').forEach(item => {
                    item.classList.remove('checked');
                });
            },

            searchCombinedServices: async function() {
                event.stopPropagation();
                
                if (this.state.selectedServices.length === 0) {
                    this.toast(' Please select at least one service');
                    return;
                }
                
                // Close dropdown
                document.getElementById('combined-dropdown').classList.remove('show');
                
                // Clear previous service markers
                this.layers.services.clearLayers();
                
                // Search for each selected service
                let totalFound = 0;
                for (const service of this.state.selectedServices) {
                    const count = await this.searchServiceSilent(service);
                    totalFound += count;
                }
                
                if (totalFound === 0) {
                    this.toast('No results found');
                } else {
                    this.toast(`Found ${totalFound} location(s) across ${this.state.selectedServices.length} service(s)`);
                }
            },

            // Silent version of searchService for combined search
            searchServiceSilent: async function(type) {
                if (this.layerData.length === 0) return 0;
                
                const searchArea = this.layerData.find(l => 
                    l.type === 'polygon' || l.type === 'rectangle' || l.type === 'circle'
                );
                
                if (!searchArea) return 0;
                
                const bounds = searchArea.layer.getBounds();
                
                const serviceConfig = {
                    'hotel': {
                        query: 'node["tourism"="hotel"]',
                        icon: 'fa-bed',
                        color: '#0ea5e9',
                        label: 'Hotel'
                    },
                    'restaurant': {
                        query: 'node["amenity"="restaurant"]',
                        icon: 'fa-utensils',
                        color: '#f59e0b',
                        label: 'Restaurant'
                    },
                    'cafe': {
                        query: 'node["amenity"="cafe"]',
                        icon: 'fa-coffee',
                        color: '#92400e',
                        label: 'Cafe'
                    },
                    'hospital': {
                        query: 'node["amenity"="hospital"]',
                        icon: 'fa-hospital-alt',
                        color: '#10b981',
                        label: 'Hospital'
                    },
                    'pharmacy': {
                        query: 'node["amenity"="pharmacy"]',
                        icon: 'fa-pills',
                        color: '#06b6d4',
                        label: 'Pharmacy'
                    }
                };
                
                const config = serviceConfig[type];
                const query = `[out:json][timeout:25];${config.query}(${bounds.getSouth()},${bounds.getWest()},${bounds.getNorth()},${bounds.getEast()});out;`;
                
                try {
                    const response = await fetch('https://overpass.kumi.systems/api/interpreter', {
                        method: 'POST',
                        body: query
                    });
                    
                    const data = await response.json();
                    let count = 0;
                    
                    data.elements.forEach(el => {
                        const customIcon = L.divIcon({
                            className: 'custom-div-icon',
                            html: `
                                <div class="map-pin pin-${type}">
                                    <div class="pin-background"></div>
                                    <i class="fas ${config.icon} pin-icon"></i>
                                </div>
                            `,
                            iconSize: [40, 50],
                            iconAnchor: [20, 45],
                            popupAnchor: [0, -45]
                        });
                        
                        const marker = L.marker([el.lat, el.lon], {
                            icon: customIcon,
                            title: el.tags.name || config.label,
                            serviceType: type
                        }).bindPopup(`
                            <div style="text-align: center; padding: 16px; min-width: 220px;">
                                <div style="margin-bottom: 12px;">
                                    <i class="fas ${config.icon}" style="font-size: 32px; color: ${config.color};"></i>
                                </div>
                                <strong style="font-size: 17px; color: #1e293b; display: block; margin-bottom: 8px; line-height: 1.3;">
                                    ${el.tags.name || config.label}
                                </strong>
                                <div style="color: #64748b; font-size: 13px; margin-bottom: 16px; font-weight: 500;">
                                     ${config.label}
                                </div>
                                
                                <button onclick="app.askAIAbout('${type}', '${(el.tags.name || config.label).replace(/'/g, "\\'")}', ${el.lat}, ${el.lon})" 
                                style="
                                    background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
                                    color: white;
                                    border: none;
                                    padding: 10px 20px;
                                    border-radius: 10px;
                                    cursor: pointer;
                                    font-weight: 600;
                                    font-size: 13px;
                                    box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
                                    transition: all 0.2s;
                                    width: 100%;
                                    margin-bottom: 8px;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    gap: 8px;
                                "
                                onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(99, 102, 241, 0.4)';"
                                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(99, 102, 241, 0.3)';">
                                    <i class="fas fa-robot"></i> Ask AI About This
                                </button>
                                
                                <button onclick="app.getDirections(${el.lat}, ${el.lon})" 
                                style="
                                    background: linear-gradient(135deg, ${config.color} 0%, ${config.color}dd 100%);
                                    color: white;
                                    border: none;
                                    padding: 10px 20px;
                                    border-radius: 10px;
                                    cursor: pointer;
                                    font-weight: 600;
                                    font-size: 13px;
                                    box-shadow: 0 4px 12px ${config.color}40;
                                    transition: all 0.2s;
                                    width: 100%;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    gap: 8px;
                                "
                                onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px ${config.color}60';"
                                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px ${config.color}40';">
                                    <i class="fas fa-route"></i> Get Directions
                                </button>
                            </div>
                        `);
                        
                        this.layers.services.addLayer(marker);
                        count++;
                    });
                    
                    return count;
                    
                } catch (error) {
                    console.error('Search error:', error);
                    return 0;
                }
            },

            // ===== SERVICE SEARCH =====
            searchService: async function(type) {
                if (this.layerData.length === 0) {
                    this.toast(' Draw an area first to search within');
                    return;
                }
                
                // Find first polygon/rectangle/circle
                const searchArea = this.layerData.find(l => 
                    l.type === 'polygon' || l.type === 'rectangle' || l.type === 'circle'
                );
                
                if (!searchArea) {
                    this.toast(' Draw a polygon, rectangle, or circle first');
                    return;
                }
                
                // Update UI
                document.querySelectorAll('.service-btn').forEach(btn => btn.classList.remove('active'));
                event.currentTarget.classList.add('active');
                
                this.toast(`Searching for ${type}...`);
                this.layers.services.clearLayers();
                
                // Get bounds
                const bounds = searchArea.layer.getBounds();
                
                // Overpass query configuration
                const serviceConfig = {
                    'hotel': {
                        query: 'node["tourism"="hotel"]',
                        icon: 'fa-bed',
                        color: '#0ea5e9',
                        label: 'Hotel'
                    },
                    'restaurant': {
                        query: 'node["amenity"="restaurant"]',
                        icon: 'fa-utensils',
                        color: '#f59e0b',
                        label: 'Restaurant'
                    },
                    'cafe': {
                        query: 'node["amenity"="cafe"]',
                        icon: 'fa-coffee',
                        color: '#92400e',
                        label: 'Cafe'
                    },
                    'hospital': {
                        query: 'node["amenity"="hospital"]',
                        icon: 'fa-hospital-alt',
                        color: '#10b981',
                        label: 'Hospital'
                    },
                    'pharmacy': {
                        query: 'node["amenity"="pharmacy"]',
                        icon: 'fa-pills',
                        color: '#06b6d4',
                        label: 'Pharmacy'
                    }
                };
                
                const config = serviceConfig[type] || serviceConfig['hotel'];
                const query = `[out:json][timeout:25];${config.query}(${bounds.getSouth()},${bounds.getWest()},${bounds.getNorth()},${bounds.getEast()});out;`;
                
                try {
                    const response = await fetch('https://overpass.kumi.systems/api/interpreter', {
                        method: 'POST',
                        body: query
                    });
                    
                    const data = await response.json();
                    let count = 0;
                    
                    data.elements.forEach(el => {
                        // Create custom pin icon
                        const customIcon = L.divIcon({
                            className: 'custom-div-icon',
                            html: `
                                <div class="map-pin pin-${type}">
                                    <div class="pin-background"></div>
                                    <i class="fas ${config.icon} pin-icon"></i>
                                </div>
                            `,
                            iconSize: [40, 50],
                            iconAnchor: [20, 45],
                            popupAnchor: [0, -45]
                        });
                        
                        const marker = L.marker([el.lat, el.lon], {
                            icon: customIcon,
                            title: el.tags.name || config.label,
                            serviceType: type
                        }).bindPopup(`
                            <div style="text-align: center; padding: 16px; min-width: 220px;">
                                <div style="margin-bottom: 12px;">
                                    <i class="fas ${config.icon}" style="font-size: 32px; color: ${config.color};"></i>
                                </div>
                                <strong style="font-size: 17px; color: #1e293b; display: block; margin-bottom: 8px; line-height: 1.3;">
                                    ${el.tags.name || config.label}
                                </strong>
                                <div style="color: #64748b; font-size: 13px; margin-bottom: 16px; font-weight: 500;">
                                     ${config.label}
                                </div>
                                
                                <button onclick="app.askAIAbout('${type}', '${(el.tags.name || config.label).replace(/'/g, "\\'")}', ${el.lat}, ${el.lon})" 
                                style="
                                    background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
                                    color: white;
                                    border: none;
                                    padding: 10px 20px;
                                    border-radius: 10px;
                                    cursor: pointer;
                                    font-weight: 600;
                                    font-size: 13px;
                                    box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
                                    transition: all 0.2s;
                                    width: 100%;
                                    margin-bottom: 8px;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    gap: 8px;
                                "
                                onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(99, 102, 241, 0.4)';"
                                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(99, 102, 241, 0.3)';">
                                    <i class="fas fa-robot"></i> Ask AI About This
                                </button>
                                
                                <button onclick="app.getDirections(${el.lat}, ${el.lon})" 
                                style="
                                    background: linear-gradient(135deg, ${config.color} 0%, ${config.color}dd 100%);
                                    color: white;
                                    border: none;
                                    padding: 10px 20px;
                                    border-radius: 10px;
                                    cursor: pointer;
                                    font-weight: 600;
                                    font-size: 13px;
                                    box-shadow: 0 4px 12px ${config.color}40;
                                    transition: all 0.2s;
                                    width: 100%;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    gap: 8px;
                                "
                                onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px ${config.color}60';"
                                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px ${config.color}40';">
                                    <i class="fas fa-route"></i> Get Directions
                                </button>
                            </div>
                        `);
                        
                        this.layers.services.addLayer(marker);
                        count++;
                    });
                    
                    if (count === 0) {
                        this.toast('No results found in this area');
                    } else {
                        this.toast(`Found ${count} ${type}(s)`);
                    }
                    
                } catch (error) {
                    console.error('Search error:', error);
                    this.toast('Search failed. Try again.');
                }
            },

            // ===== USER LOCATION =====
            locateUser: function() {
                this.toast('Locating...');
                
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            const { latitude, longitude } = position.coords;
                            this.state.userLocation = { lat: latitude, lng: longitude };
                            
                            // Clear previous user marker
                            this.layers.user.clearLayers();
                            
                            // Add new marker
                            L.circleMarker([latitude, longitude], {
                                radius: 10,
                                fillColor: '#6366f1',
                                color: '#fff',
                                weight: 3,
                                opacity: 1,
                                fillOpacity: 1
                            }).addTo(this.layers.user);
                            
                            // Add accuracy circle
                            const accuracy = position.coords.accuracy;
                            L.circle([latitude, longitude], {
                                radius: accuracy,
                                fillColor: '#6366f1',
                                color: '#6366f1',
                                weight: 1,
                                opacity: 0.3,
                                fillOpacity: 0.1
                            }).addTo(this.layers.user);
                            
                            map.flyTo([latitude, longitude], 15, {
                                duration: 1.5
                            });
                            
                            this.toast('Location found');
                        },
                        (error) => {
                            this.toast('Location access denied');
                        }
                    );
                } else {
                    this.toast('Geolocation not supported');
                }
            },

            // ===== ROUTING =====
            getDirections: async function(destLat, destLng) {
                // Check for marked location first, then user location
                let startLocation = this.state.markedLocation;
                
                if (!startLocation && !this.state.userLocation) {
                    this.toast('Getting your location first...');
                    await new Promise((resolve) => {
                        navigator.geolocation.getCurrentPosition(
                            (pos) => {
                                this.state.userLocation = {
                                    lat: pos.coords.latitude,
                                    lng: pos.coords.longitude
                                };
                                resolve();
                            },
                            () => {
                                this.toast('Please set a starting point or enable location');
                                resolve();
                            }
                        );
                    });
                }
                
                // Use marked location if available, otherwise use GPS location
                if (!startLocation) {
                    startLocation = this.state.userLocation;
                }
                
                if (!startLocation) return;
                
                this.state.routeDestination = { lat: destLat, lng: destLng };
                map.closePopup();
                
                this.calculateRoute();
            },

            calculateRoute: async function() {
                // Use marked location if available, otherwise use GPS location
                const start = this.state.markedLocation || this.state.userLocation;
                const end = this.state.routeDestination;
                
                if (!start || !end) return;
                
                const url = `https://router.project-osrm.org/route/v1/${this.state.routeMode}/${start.lng},${start.lat};${end.lng},${end.lat}?overview=full&steps=true&geometries=geojson`;
                
                try {
                    this.toast('Calculating route...');
                    
                    const response = await fetch(url);
                    const data = await response.json();
                    
                    if (data.code !== 'Ok') throw new Error('Route not found');
                    
                    const route = data.routes[0];
                    
                    // Clear previous route
                    this.layers.route.clearLayers();
                    
                    // Draw route
                    L.geoJSON(route.geometry, {
                        style: {
                            color: '#6366f1',
                            weight: 5,
                            opacity: 0.8,
                            lineJoin: 'round',
                            lineCap: 'round'
                        }
                    }).addTo(this.layers.route);
                    
                    // Fit bounds
                    map.fitBounds(this.layers.route.getBounds(), {
                        padding: [80, 80]
                    });
                    
                    // Show route panel
                    this.showRoutePanel(route);
                    
                } catch (error) {
                    console.error('Route error:', error);
                    this.toast('Route calculation failed');
                }
            },

            showRoutePanel: function(route) {
                const panel = document.getElementById('route-panel');
                panel.classList.add('active');

                // Store route for navigation
                this.state.currentRoute = route;

                // Save to history
                this.saveRouteToHistory(route);

                // Update time and distance
                const minutes = Math.round(route.duration / 60);
                const hours = Math.floor(minutes / 60);
                const mins = minutes % 60;
                
                const timeStr = hours > 0 ? `${hours}h ${mins}m` : `${mins} min`;
                const distStr = (route.distance / 1000).toFixed(1);
                
                document.getElementById('route-time').textContent = timeStr;
                document.getElementById('route-dist').textContent = `${distStr} km`;
                
                // Update steps
                const stepsContainer = document.getElementById('route-steps');
                stepsContainer.innerHTML = route.legs[0].steps.map(step => `
                    <div class="step-item">
                        <div class="step-icon">
                            <i class="fas fa-arrow-up"></i>
                        </div>
                        <div class="step-content">
                            <div>${step.name || 'Continue on road'}</div>
                            <div class="step-distance">${(step.distance / 1000).toFixed(1)} km</div>
                        </div>
                    </div>
                `).join('');
            },

            switchMode: function(mode, btn) {
                this.state.routeMode = mode;
                
                // Update UI
                document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                // Recalculate route
                if (this.state.routeDestination) {
                    this.calculateRoute();
                }
            },

            clearRoute: function() {
                this.layers.route.clearLayers();
                document.getElementById('route-panel').classList.remove('active');
                this.state.routeDestination = null;
                this.state.currentRoute = null;
            },

            // ===== TRANSPORT LAYERS =====
            toggleTransportLayer: function(layerType) {
                const toggleElement = event.currentTarget;
                const index = activeTransportLayers.indexOf(layerType);
                
                if (index > -1) {
                    // Remove layer
                    activeTransportLayers.splice(index, 1);
                    toggleElement.classList.remove('active');
                    if (transportLayers[layerType]) {
                        map.removeLayer(transportLayers[layerType]);
                    }
                } else {
                    // Add layer
                    activeTransportLayers.push(layerType);
                    toggleElement.classList.add('active');
                    if (transportLayers[layerType]) {
                        transportLayers[layerType].addTo(map);
                    }
                }
            },

            // ===== NAVIGATION MODE =====
            startNavigation: function() {
                if (!this.state.currentRoute) {
                    this.toast('No route calculated. Please select a destination first.');
                    return;
                }

                this.state.navigationActive = true;
                this.state.currentStepIndex = 0;

                // Show navigation overlay
                document.getElementById('nav-overlay').classList.add('active');
                
                // Show transport layer controls
                document.getElementById('transport-controls').classList.add('show');

                // Hide other UI elements
                document.querySelector('.header-bar').style.opacity = '0';
                document.querySelector('.draw-tools-panel').style.opacity = '0';
                document.querySelector('.layers-panel').style.opacity = '0';
                document.getElementById('route-panel').classList.remove('active');

                // Enhance route visualization
                this.layers.route.clearLayers();
                L.geoJSON(this.state.currentRoute.geometry, {
                    style: {
                        color: '#10b981',
                        weight: 8,
                        opacity: 0.9,
                        lineJoin: 'round',
                        lineCap: 'round'
                    }
                }).addTo(this.layers.route);

                // Start navigation updates
                this.updateNavigationUI();
                
                // Simulate progress (in real app, use GPS tracking)
                this.state.navigationInterval = setInterval(() => {
                    this.simulateNavigationProgress();
                }, 3000);

                this.toast('Navigation started!');
            },

            updateNavigationUI: function() {
                const route = this.state.currentRoute;
                const steps = route.legs[0].steps;
                const currentStep = steps[this.state.currentStepIndex];

                if (!currentStep) return;

                // Update ETA
                const remainingDuration = steps.slice(this.state.currentStepIndex)
                    .reduce((sum, step) => sum + step.duration, 0);
                const mins = Math.round(remainingDuration / 60);
                document.getElementById('nav-eta').textContent = 
                    mins > 60 ? `${Math.floor(mins/60)}h ${mins%60}m` : `${mins} min`;

                // Update remaining distance
                const remainingDistance = steps.slice(this.state.currentStepIndex)
                    .reduce((sum, step) => sum + step.distance, 0);
                document.getElementById('nav-distance').textContent = 
                    `${(remainingDistance / 1000).toFixed(1)} km remaining`;

                // Update current instruction
                document.getElementById('nav-instruction-main').textContent = 
                    currentStep.name || 'Continue on current road';
                document.getElementById('nav-instruction-distance').textContent = 
                    `in ${(currentStep.distance / 1000).toFixed(1)} km`;

                // Update maneuver icon
                const maneuverIcon = this.getManeuverIcon(currentStep);
                document.getElementById('nav-maneuver-icon').className = `fas ${maneuverIcon}`;

                // Update next steps
                const nextStepsHtml = steps.slice(this.state.currentStepIndex + 1, this.state.currentStepIndex + 4)
                    .map(step => `
                        <div class="nav-next-step">
                            <i class="fas ${this.getManeuverIcon(step)}"></i>
                            <div>${step.name || 'Continue'}</div>
                        </div>
                    `).join('');
                document.getElementById('nav-next-steps').innerHTML = nextStepsHtml;

                // Update progress bar
                const progress = (this.state.currentStepIndex / steps.length) * 100;
                document.getElementById('nav-progress').style.width = `${progress}%`;
            },

            getManeuverIcon: function(step) {
                const name = step.name?.toLowerCase() || '';
                
                if (name.includes('left')) return 'fa-arrow-left';
                if (name.includes('right')) return 'fa-arrow-right';
                if (name.includes('straight') || name.includes('continue')) return 'fa-arrow-up';
                if (name.includes('u-turn')) return 'fa-undo';
                if (name.includes('exit')) return 'fa-sign-out-alt';
                if (name.includes('merge')) return 'fa-code-branch';
                if (name.includes('roundabout')) return 'fa-circle-notch';
                
                return 'fa-arrow-up';
            },

            simulateNavigationProgress: function() {
                const steps = this.state.currentRoute.legs[0].steps;
                
                if (this.state.currentStepIndex < steps.length - 1) {
                    this.state.currentStepIndex++;
                    this.updateNavigationUI();
                    
                    // Announce step (in real app, use text-to-speech)
                    const currentStep = steps[this.state.currentStepIndex];
                    this.toast(`Next: ${currentStep.name || 'Continue on current road'}`);
                } else {
                    // Arrived at destination
                    this.arriveAtDestination();
                }
            },

            arriveAtDestination: function() {
                clearInterval(this.state.navigationInterval);
                
                document.getElementById('nav-instruction-main').textContent = 'You have arrived!';
                document.getElementById('nav-instruction-distance').textContent = 'Destination reached';
                document.getElementById('nav-maneuver-icon').className = 'fas fa-flag-checkered';
                
                setTimeout(() => {
                    this.exitNavigation();
                    this.toast(' You have arrived at your destination!');
                }, 3000);
            },

            exitNavigation: function() {
                this.state.navigationActive = false;
                clearInterval(this.state.navigationInterval);

                // Hide navigation overlay
                document.getElementById('nav-overlay').classList.remove('active');
                
                // Hide transport controls
                document.getElementById('transport-controls').classList.remove('show');

                // Show UI elements
                document.querySelector('.header-bar').style.opacity = '1';
                document.querySelector('.draw-tools-panel').style.opacity = '1';
                document.querySelector('.layers-panel').style.opacity = '1';

                // Restore normal route visualization
                this.layers.route.clearLayers();
                if (this.state.currentRoute) {
                    L.geoJSON(this.state.currentRoute.geometry, {
                        style: {
                            color: '#6366f1',
                            weight: 5,
                            opacity: 0.8,
                            lineJoin: 'round',
                            lineCap: 'round'
                        }
                    }).addTo(this.layers.route);
                }

                this.toast('Navigation ended');
            },

            // ===== ROUTING HISTORY =====
            saveRouteToHistory: function(route) {
                const startLocation = this.state.markedLocation || this.state.userLocation;
                const endLocation = this.state.routeDestination;

                if (!startLocation || !endLocation) return;

                const historyItem = {
                    id: Date.now(),
                    timestamp: new Date(),
                    mode: this.state.routeMode,
                    from: {
                        lat: startLocation.lat,
                        lng: startLocation.lng,
                        name: startLocation.name || 'Your Location'
                    },
                    to: {
                        lat: endLocation.lat,
                        lng: endLocation.lng,
                        name: endLocation.name || 'Destination'
                    },
                    distance: route.distance,
                    duration: route.duration,
                    steps: route.legs[0].steps,
                    geometry: route.geometry
                };

                // Add to beginning of array (most recent first)
                this.routingHistory.unshift(historyItem);

                // Limit to 20 most recent routes
                if (this.routingHistory.length > 20) {
                    this.routingHistory = this.routingHistory.slice(0, 20);
                }

                // Update UI
                this.updateHistoryUI();
                this.updateHistoryBadge();

                // Save to localStorage
                this.saveHistoryToStorage();
            },

            updateHistoryUI: function() {
                const container = document.getElementById('history-list');

                if (this.routingHistory.length === 0) {
                    container.innerHTML = `
                        <div class="history-empty">
                            <i class="fas fa-map-marked-alt"></i>
                            <div class="history-empty-text">
                                No routing history yet.<br>
                                Start navigating to save your routes!
                            </div>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = this.routingHistory.map(item => `
                    <div class="history-item" id="history-${item.id}">
                        <div class="history-item-header">
                            <div class="history-date">${this.formatDate(item.timestamp)}</div>
                            <div class="history-mode-icon">
                                <i class="fas ${this.getModeIcon(item.mode)}"></i>
                            </div>
                        </div>
                        
                        <div class="history-route">
                            <div class="history-location location-from">
                                <i class="fas fa-circle"></i>
                                <div class="location-text">${item.from.name}</div>
                            </div>
                            <div class="history-location location-to">
                                <i class="fas fa-map-marker-alt"></i>
                                <div class="location-text">${item.to.name}</div>
                            </div>
                        </div>
                        
                        <div class="history-stats">
                            <div class="history-stat">
                                <i class="fas fa-clock"></i>
                                <strong>${this.formatDuration(item.duration)}</strong>
                            </div>
                            <div class="history-stat">
                                <i class="fas fa-road"></i>
                                <strong>${(item.distance / 1000).toFixed(1)} km</strong>
                            </div>
                            <div class="history-stat">
                                <i class="fas fa-list"></i>
                                <strong>${item.steps.length} steps</strong>
                            </div>
                        </div>

                        <div class="history-detail">
                            <div class="detail-title">Route Details</div>
                            ${item.steps.map((step, idx) => `
                                <div class="detail-step">
                                    <div class="detail-step-number">${idx + 1}</div>
                                    <div class="detail-step-content">
                                        <div class="detail-step-name">${step.name || 'Continue on road'}</div>
                                        <div class="detail-step-distance">${(step.distance / 1000).toFixed(2)} km - ${Math.round(step.duration / 60)} min</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>

                        <div class="history-actions">
                            <button class="history-action-btn btn-replay" onclick="app.replayRoute(${item.id})">
                                <i class="fas fa-play"></i> Replay Route
                            </button>
                            <button class="history-action-btn" onclick="app.toggleHistoryDetail(${item.id})" style="background: #e0e7ff; color: #6366f1;">
                                <i class="fas fa-chevron-down"></i> Details
                            </button>
                            <button class="history-action-btn btn-delete" onclick="app.deleteHistoryItem(${item.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `).join('');
            },

            updateHistoryBadge: function() {
                const badge = document.getElementById('history-count');
                badge.textContent = this.routingHistory.length;
                badge.style.display = this.routingHistory.length > 0 ? 'grid' : 'none';
            },

            toggleHistory: function() {
                const panel = document.getElementById('history-panel');
                panel.classList.toggle('show');
            },

            toggleHistoryDetail: function(id) {
                const item = document.getElementById(`history-${id}`);
                const isExpanded = item.classList.contains('expanded');
                
                // Close all other items
                document.querySelectorAll('.history-item').forEach(el => {
                    el.classList.remove('expanded');
                });

                // Toggle current item
                if (!isExpanded) {
                    item.classList.add('expanded');
                    
                    // Update button icon
                    const btn = item.querySelector('.history-action-btn:nth-child(2) i');
                    if (btn) btn.className = 'fas fa-chevron-up';
                } else {
                    // Update button icon back
                    const btn = item.querySelector('.history-action-btn:nth-child(2) i');
                    if (btn) btn.className = 'fas fa-chevron-down';
                }
            },

            replayRoute: function(id) {
                const historyItem = this.routingHistory.find(item => item.id === id);
                if (!historyItem) return;

                // Close history panel
                document.getElementById('history-panel').classList.remove('show');

                // Set locations
                this.state.markedLocation = historyItem.from;
                this.state.routeDestination = historyItem.to;
                this.state.routeMode = historyItem.mode;

                // Clear existing markers
                this.layers.user.clearLayers();
                this.layers.route.clearLayers();

                // Add start marker
                const startIcon = L.divIcon({
                    className: 'custom-div-icon',
                    html: `
                        <div class="map-pin">
                            <div class="pin-background" style="background: #ef4444;"></div>
                            <i class="fas fa-flag-checkered pin-icon"></i>
                        </div>
                    `,
                    iconSize: [40, 50],
                    iconAnchor: [20, 45],
                    popupAnchor: [0, -45]
                });

                L.marker([historyItem.from.lat, historyItem.from.lng], { icon: startIcon })
                    .bindPopup(`<div style="text-align: center; padding: 8px;"><strong>Starting Point</strong><br><span style="font-size: 12px; color: #64748b;">${historyItem.from.name}</span></div>`)
                    .addTo(this.layers.user);

                // Add end marker
                const endIcon = L.divIcon({
                    className: 'custom-div-icon',
                    html: `
                        <div class="map-pin">
                            <div class="pin-background" style="background: #10b981;"></div>
                            <i class="fas fa-map-marker-alt pin-icon"></i>
                        </div>
                    `,
                    iconSize: [40, 50],
                    iconAnchor: [20, 45],
                    popupAnchor: [0, -45]
                });

                L.marker([historyItem.to.lat, historyItem.to.lng], { icon: endIcon })
                    .bindPopup(`<div style="text-align: center; padding: 8px;"><strong>Destination</strong><br><span style="font-size: 12px; color: #64748b;">${historyItem.to.name}</span></div>`)
                    .addTo(this.layers.user);

                // Draw route
                L.geoJSON(historyItem.geometry, {
                    style: {
                        color: '#6366f1',
                        weight: 5,
                        opacity: 0.8,
                        lineJoin: 'round',
                        lineCap: 'round'
                    }
                }).addTo(this.layers.route);

                // Set up route for navigation
                this.state.currentRoute = {
                    distance: historyItem.distance,
                    duration: historyItem.duration,
                    geometry: historyItem.geometry,
                    legs: [{
                        steps: historyItem.steps
                    }]
                };

                // Show route panel
                this.showRoutePanel(this.state.currentRoute);

                // Fit map to route
                map.fitBounds(this.layers.route.getBounds(), { padding: [80, 80] });

                this.toast('Route loaded from history');
            },

            deleteHistoryItem: function(id) {
                if (!confirm('Delete this route from history?')) return;

                this.routingHistory = this.routingHistory.filter(item => item.id !== id);
                this.updateHistoryUI();
                this.updateHistoryBadge();
                this.saveHistoryToStorage();
                this.toast('Route deleted from history');
            },

            clearHistory: function() {
                if (this.routingHistory.length === 0) return;
                
                if (!confirm(`Clear all ${this.routingHistory.length} routes from history?`)) return;

                this.routingHistory = [];
                this.updateHistoryUI();
                this.updateHistoryBadge();
                this.saveHistoryToStorage();
                this.toast('History cleared');
            },

            saveHistoryToStorage: function() {
                try {
                    localStorage.setItem('routingHistory', JSON.stringify(this.routingHistory));
                } catch (e) {
                    console.error('Failed to save history:', e);
                }
            },

            loadHistoryFromStorage: function() {
                try {
                    const saved = localStorage.getItem('routingHistory');
                    if (saved) {
                        this.routingHistory = JSON.parse(saved);
                        // Convert timestamp strings back to Date objects
                        this.routingHistory.forEach(item => {
                            item.timestamp = new Date(item.timestamp);
                        });
                        this.updateHistoryUI();
                        this.updateHistoryBadge();
                    }
                } catch (e) {
                    console.error('Failed to load history:', e);
                }
            },

            getModeIcon: function(mode) {
                const icons = {
                    'driving': 'fa-car',
                    'walking': 'fa-walking',
                    'cycling': 'fa-bicycle'
                };
                return icons[mode] || 'fa-car';
            },

            formatDate: function(date) {
                const now = new Date();
                const diff = now - date;
                const minutes = Math.floor(diff / 60000);
                const hours = Math.floor(diff / 3600000);
                const days = Math.floor(diff / 86400000);

                if (minutes < 1) return 'Just now';
                if (minutes < 60) return `${minutes}m ago`;
                if (hours < 24) return `${hours}h ago`;
                if (days < 7) return `${days}d ago`;
                
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            },

            formatDuration: function(seconds) {
                const mins = Math.round(seconds / 60);
                const hours = Math.floor(mins / 60);
                const remainingMins = mins % 60;
                
                if (hours > 0) {
                    return `${hours}h ${remainingMins}m`;
                }
                return `${mins}m`;
            },

            // ===== AI ASSISTANT =====
            toggleAI: function() {
                const panel = document.getElementById('ai-panel');
                const toggle = document.getElementById('ai-toggle');
                
                panel.classList.toggle('show');
                toggle.classList.toggle('active');
                
                if (panel.classList.contains('show')) {
                    document.getElementById('ai-input').focus();
                }
            },

            quickAsk: function(query) {
                let fullQuery = '';
                switch(query) {
                    case 'compare hotels':
                        fullQuery = 'Compare all the hotels visible on my map and recommend the best one';
                        break;
                    case 'best restaurant':
                        fullQuery = 'Which restaurant on my map has the best ratings and reviews?';
                        break;
                    case 'quiet cafe':
                        fullQuery = 'Find me a quiet cafe good for working with WiFi';
                        break;
                    case 'nearest hospital':
                        fullQuery = 'What is the nearest hospital with emergency services?';
                        break;
                    case '24hr pharmacy':
                        fullQuery = 'Which pharmacy is open 24 hours?';
                        break;
                }
                
                document.getElementById('ai-input').value = fullQuery;
                this.sendAIMessage();
            },

            sendAIMessage: async function() {
                const input = document.getElementById('ai-input');
                const query = input.value.trim();
                
                if (!query) return;
                
                // Clear input
                input.value = '';
                
                // Add user message to chat
                this.addAIMessage('user', query);
                
                // Show typing indicator
                this.showAITyping();
                
                // Prepare context
                const context = this.gatherAIContext();
                
                // Simulate AI response (in production, call actual API)
                setTimeout(() => {
                    this.generateAIResponse(query, context);
                }, 2000);
            },

            addAIMessage: function(role, content) {
                const chatArea = document.getElementById('ai-chat');
                
                const messageDiv = document.createElement('div');
                messageDiv.className = 'ai-message';
                
                const avatarDiv = document.createElement('div');
                avatarDiv.className = `ai-avatar ${role}`;
                avatarDiv.innerHTML = role === 'user' ? '<i class="fas fa-user"></i>' : '<i class="fas fa-robot"></i>';
                
                const contentDiv = document.createElement('div');
                contentDiv.className = 'ai-message-content';
                contentDiv.innerHTML = content;
                
                messageDiv.appendChild(avatarDiv);
                messageDiv.appendChild(contentDiv);
                chatArea.appendChild(messageDiv);
                
                // Scroll to bottom
                chatArea.scrollTop = chatArea.scrollHeight;
            },

            showAITyping: function() {
                const chatArea = document.getElementById('ai-chat');
                
                const typingDiv = document.createElement('div');
                typingDiv.className = 'ai-message';
                typingDiv.id = 'ai-typing';
                
                typingDiv.innerHTML = `
                    <div class="ai-avatar bot">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="ai-message-content">
                        <div class="ai-typing">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                    </div>
                `;
                
                chatArea.appendChild(typingDiv);
                chatArea.scrollTop = chatArea.scrollHeight;
            },

            removeAITyping: function() {
                const typing = document.getElementById('ai-typing');
                if (typing) {
                    typing.remove();
                }
            },

            gatherAIContext: function() {
                const context = {
                    userLocation: this.state.userLocation || this.state.markedLocation,
                    visibleServices: [],
                    mapBounds: map.getBounds(),
                    currentZoom: map.getZoom()
                };
                
                // Gather visible service markers
                this.layers.services.eachLayer(layer => {
                    if (layer.getLatLng) {
                        const latlng = layer.getLatLng();
                        context.visibleServices.push({
                            name: layer.options.title || 'Unknown',
                            type: layer.options.serviceType || 'unknown',
                            lat: latlng.lat,
                            lng: latlng.lng
                        });
                    }
                });
                
                return context;
            },

            generateAIResponse: function(query, context) {
                this.removeAITyping();
                
                const lowerQuery = query.toLowerCase();
                let response = '';
                
                // Simulate intelligent responses based on query
                if (lowerQuery.includes('hotel') && lowerQuery.includes('compare')) {
                    response = this.generateHotelComparison(context);
                } else if (lowerQuery.includes('restaurant') && (lowerQuery.includes('best') || lowerQuery.includes('rating'))) {
                    response = this.generateRestaurantRecommendation(context);
                } else if (lowerQuery.includes('cafe') && lowerQuery.includes('quiet')) {
                    response = this.generateCafeRecommendation(context);
                } else if (lowerQuery.includes('hospital') || lowerQuery.includes('emergency')) {
                    response = this.generateHospitalInfo(context);
                } else if (lowerQuery.includes('pharmacy') && lowerQuery.includes('24')) {
                    response = this.generatePharmacyInfo(context);
                } else {
                    response = this.generateGenericResponse(query, context);
                }
                
                this.addAIMessage('bot', response);
            },

            generateHotelComparison: function(context) {
                const hotels = context.visibleServices.filter(s => s.type === 'hotel');
                
                if (hotels.length === 0) {
                    return `I don't see any hotels on your map yet. Try drawing a search area and clicking the <strong>Hotels</strong> button to find nearby accommodations! `;
                }
                
                let response = `I found <strong>${hotels.length} hotel${hotels.length > 1 ? 's' : ''}</strong> in your search area. Based on typical data from Booking.com and Google Maps:<br><br>`;
                
                hotels.slice(0, 3).forEach((hotel, idx) => {
                    const rating = (4.0 + Math.random() * 1.0).toFixed(1);
                    const price = 80 + Math.floor(Math.random() * 150);
                    const amenities = ['WiFi', 'Parking', 'Breakfast', 'Pool', 'Gym', 'Spa'];
                    const selectedAmenities = amenities.sort(() => 0.5 - Math.random()).slice(0, 2);
                    
                    response += `<strong>${idx + 1}. ${hotel.name}</strong><br>`;
                    response += ` ${rating}/5 rating  $${price}/night<br>`;
                    response += ` ${selectedAmenities.join(', ')}<br>`;
                    
                    if (idx === 0) response += `<span style="color: #10b981; font-weight: 600;"> Best Overall</span><br>`;
                    response += `<br>`;
                });
                
                response += `<div class="ai-action-buttons">
                    <button class="ai-action-btn">
                        <i class="fas fa-external-link-alt"></i> View on Booking.com
                    </button>
                </div>`;
                
                response += `<br><small style="color: #94a3b8;"> In production, this would show real-time data from Booking.com API</small>`;
                
                return response;
            },

            generateRestaurantRecommendation: function(context) {
                const restaurants = context.visibleServices.filter(s => s.type === 'restaurant');
                
                if (restaurants.length === 0) {
                    return `No restaurants found on your map. Draw a search area and click <strong>Restaurants</strong> to discover dining options! `;
                }
                
                const topRestaurant = restaurants[0];
                const rating = (4.2 + Math.random() * 0.7).toFixed(1);
                const cuisines = ['Italian', 'Japanese', 'Mexican', 'Thai', 'French', 'Mediterranean'];
                const cuisine = cuisines[Math.floor(Math.random() * cuisines.length)];
                const priceLevel = ['$', '$$', '$$$'][Math.floor(Math.random() * 3)];
                
                let response = `Based on ratings from Google Maps and Yelp:<br><br>`;
                response += `<strong> ${topRestaurant.name}</strong><br>`;
                response += ` ${rating}/5 (${Math.floor(Math.random() * 500 + 200)} reviews)<br>`;
                response += ` ${cuisine} cuisine  ${priceLevel}<br>`;
                response += ` Open now  Moderate wait time<br><br>`;
                
                response += `<strong>What reviewers say:</strong><br>`;
                response += `"Excellent food quality and service. The ambiance is perfect for a special dinner."<br><br>`;
                
                response += `<div class="ai-action-buttons">
                    <button class="ai-action-btn">
                        <i class="fas fa-calendar-check"></i> Reserve Table
                    </button>
                    <button class="ai-action-btn" onclick="app.getDirections(${topRestaurant.lat}, ${topRestaurant.lng})">
                        <i class="fas fa-directions"></i> Directions
                    </button>
                </div>`;
                
                return response;
            },

            generateCafeRecommendation: function(context) {
                const cafes = context.visibleServices.filter(s => s.type === 'cafe');
                
                if (cafes.length === 0) {
                    return `I don't see any cafes on your map. Search for <strong>Cafes</strong> in your area to find the perfect work spot! `;
                }
                
                const cafe = cafes[0];
                const rating = (4.3 + Math.random() * 0.6).toFixed(1);
                
                let response = `Perfect for remote work! <br><br>`;
                response += `<strong>${cafe.name}</strong><br>`;
                response += ` ${rating}/5 rating<br><br>`;
                
                response += `<strong>Work-Friendly Features:</strong><br>`;
                response += ` Free high-speed WiFi<br>`;
                response += ` Power outlets at most tables<br>`;
                response += ` Quiet atmosphere<br>`;
                response += ` Comfortable seating<br><br>`;
                
                response += `<strong>Current status:</strong> Moderately busy<br><br>`;
                
                response += `<div class="ai-action-buttons">
                    <button class="ai-action-btn" onclick="app.getDirections(${cafe.lat}, ${cafe.lng})">
                        <i class="fas fa-directions"></i> Navigate
                    </button>
                </div>`;
                
                return response;
            },

            generateHospitalInfo: function(context) {
                const hospitals = context.visibleServices.filter(s => s.type === 'hospital');
                
                if (hospitals.length === 0) {
                    return `No hospitals found in your search area. Expand your search or try a different location. `;
                }
                
                const hospital = hospitals[0];
                
                let response = `<strong> ${hospital.name}</strong><br><br>`;
                response += `<strong>Emergency Services:</strong> Available 24/7<br>`;
                response += `<strong>Distance:</strong> ${(Math.random() * 3 + 0.5).toFixed(1)} km<br>`;
                response += `<strong>Estimated wait:</strong> 15-30 minutes<br><br>`;
                
                response += `<strong>Departments:</strong><br>`;
                response += ` Emergency Room<br>`;
                response += ` General Medicine<br>`;
                response += ` Cardiology<br><br>`;
                
                response += `<div class="ai-action-buttons">
                    <button class="ai-action-btn" onclick="app.getDirections(${hospital.lat}, ${hospital.lng})">
                        <i class="fas fa-ambulance"></i> Navigate Now
                    </button>
                </div>`;
                
                response += `<br><small style="color: #94a3b8;"> For emergencies, call 911</small>`;
                
                return response;
            },

            generatePharmacyInfo: function(context) {
                const pharmacies = context.visibleServices.filter(s => s.type === 'pharmacy');
                
                if (pharmacies.length === 0) {
                    return `No pharmacies found. Search for <strong>Pharmacies</strong> in your area! `;
                }
                
                const pharmacy = pharmacies[0];
                const is24hr = Math.random() > 0.5;
                
                let response = `<strong> ${pharmacy.name}</strong><br><br>`;
                
                if (is24hr) {
                    response += ` <strong style="color: #10b981;">Open 24 Hours</strong><br><br>`;
                } else {
                    response += ` Hours: 8:00 AM - 10:00 PM<br><br>`;
                }
                
                response += `<strong>Services:</strong><br>`;
                response += ` Prescription filling<br>`;
                response += ` Flu shots<br>`;
                response += ` OTC medications<br><br>`;
                
                response += `<div class="ai-action-buttons">
                    <button class="ai-action-btn" onclick="app.getDirections(${pharmacy.lat}, ${pharmacy.lng})">
                        <i class="fas fa-directions"></i> Directions
                    </button>
                </div>`;
                
                return response;
            },

            generateGenericResponse: function(query, context) {
                return `I'd be happy to help! I can assist you with:<br><br>
                     <strong>Hotels:</strong> Compare prices, ratings, amenities<br>
                     <strong>Restaurants:</strong> Find top-rated options<br>
                     <strong>Cafes:</strong> Discover work-friendly spots<br>
                     <strong>Hospitals:</strong> Locate emergency services<br>
                     <strong>Pharmacies:</strong> Find 24-hour locations<br><br>
                    
                    Try asking:<br>
                     "Which hotel has the best price?"<br>
                     "Find a quiet cafe for work"<br>
                     "Where's the nearest pharmacy?"<br><br>
                    
                    First, search for services using the buttons at the top! `;
            },

            // ===== ASK AI ABOUT SPECIFIC SERVICE =====
            askAIAbout: function(type, name, lat, lng) {
                // Open AI panel
                const panel = document.getElementById('ai-panel');
                const toggle = document.getElementById('ai-toggle');
                
                if (!panel.classList.contains('show')) {
                    panel.classList.add('show');
                    toggle.classList.add('active');
                }
                
                // Focus on input
                setTimeout(() => {
                    document.getElementById('ai-input').focus();
                }, 300);
                
                // Gather context about this specific service
                const serviceData = {
                    type: type,
                    name: name,
                    coordinates: { lat, lng }
                };
                
                // Get all similar services for comparison
                const similarServices = [];
                this.layers.services.eachLayer(layer => {
                    if (layer.options.serviceType === type) {
                        similarServices.push({
                            name: layer.options.title,
                            lat: layer.getLatLng().lat,
                            lng: layer.getLatLng().lng
                        });
                    }
                });
                
                // Auto-generate query
                let query = `Tell me about ${name}`;
                
                // Add user message
                this.addAIMessage('user', query);
                
                // Show typing indicator
                this.showAITyping();
                
                // Generate focused response
                setTimeout(() => {
                    this.generateServiceSpecificResponse(serviceData, similarServices);
                }, 1500);
            },

            generateServiceSpecificResponse: function(service, similarServices) {
                this.removeAITyping();
                
                const type = service.type;
                const name = service.name;
                const similarCount = similarServices.length - 1;
                
                let response = `<div style="border-left: 3px solid #6366f1; padding-left: 12px; margin-bottom: 12px;">`;
                response += `<strong style="font-size: 15px; color: #1e293b;"> ${name}</strong></div>`;
                
                // Type-specific information
                if (type === 'hotel') {
                    const rating = (4.0 + Math.random() * 1.0).toFixed(1);
                    const price = 80 + Math.floor(Math.random() * 150);
                    const hotelTypes = ['Luxury Hotel', 'Business Hotel', 'Budget Hotel', 'Boutique Hotel'];
                    const hotelType = hotelTypes[Math.floor(Math.random() * hotelTypes.length)];
                    
                    response += `<strong> Hotel Information:</strong><br>`;
                    response += ` <strong>Rating:</strong> ${rating}/5.0<br>`;
                    response += ` <strong>Est. Price:</strong> $${price}/night<br>`;
                    response += ` <strong>Type:</strong> ${hotelType}<br><br>`;
                    
                    response += `<strong> Amenities:</strong><br>`;
                    const amenities = ['Free WiFi', 'Swimming Pool', 'Fitness Center', 'Spa & Wellness', 'Restaurant', 'Free Parking', 'Room Service', 'Concierge'];
                    const selected = amenities.sort(() => 0.5 - Math.random()).slice(0, 4);
                    selected.forEach(a => response += ` ${a}<br>`);
                    response += `<br>`;
                    
                    response += `<strong> Guest Reviews:</strong><br>`;
                    response += `<em>"${['Excellent location and service', 'Clean and comfortable rooms', 'Great value for money', 'Friendly and helpful staff'][Math.floor(Math.random() * 4)]}"</em><br><br>`;
                    
                } else if (type === 'restaurant') {
                    const rating = (4.0 + Math.random() * 0.9).toFixed(1);
                    const cuisines = ['Italian', 'Japanese', 'Mexican', 'French', 'Thai', 'Mediterranean', 'Chinese', 'Indian'];
                    const cuisine = cuisines[Math.floor(Math.random() * cuisines.length)];
                    const priceLevel = ['$', '$$', '$$$'][Math.floor(Math.random() * 3)];
                    const capacity = 20 + Math.floor(Math.random() * 100);
                    
                    response += `<strong> Restaurant Details:</strong><br>`;
                    response += ` <strong>Rating:</strong> ${rating}/5.0<br>`;
                    response += ` <strong>Cuisine:</strong> ${cuisine}<br>`;
                    response += ` <strong>Price Range:</strong> ${priceLevel}<br>`;
                    response += ` <strong>Seating:</strong> ${capacity} guests<br><br>`;
                    
                    response += `<strong> Popular Dishes:</strong><br>`;
                    const dishes = ['Chef\'s Special', 'Signature Pasta', 'Grilled Seafood', 'House Specialty', 'Traditional Platter'];
                    response += ` ${dishes[Math.floor(Math.random() * dishes.length)]}<br>`;
                    response += ` ${dishes[Math.floor(Math.random() * dishes.length)]}<br><br>`;
                    
                    response += `<strong> Hours:</strong> ${Math.random() > 0.3 ? 'Open Now' : 'Closed'}<br>`;
                    response += `<strong> Reservations:</strong> ${Math.random() > 0.5 ? 'Recommended' : 'Walk-ins welcome'}<br><br>`;
                    
                } else if (type === 'cafe') {
                    const rating = (4.0 + Math.random() * 0.8).toFixed(1);
                    const specialties = ['Artisan Coffee', 'Fresh Pastries', 'Specialty Teas', 'Organic Options'];
                    const atmosphere = ['Cozy & Warm', 'Modern & Minimal', 'Rustic Charm', 'Industrial Chic'];
                    
                    response += `<strong> Cafe Details:</strong><br>`;
                    response += ` <strong>Rating:</strong> ${rating}/5.0<br>`;
                    response += ` <strong>Atmosphere:</strong> ${atmosphere[Math.floor(Math.random() * atmosphere.length)]}<br>`;
                    response += ` <strong>Specialty:</strong> ${specialties[Math.floor(Math.random() * specialties.length)]}<br><br>`;
                    
                    response += `<strong> Work-Friendly:</strong><br>`;
                    const hasWifi = Math.random() > 0.2;
                    response += ` WiFi: ${hasWifi ? ' Free & Fast' : ' Not Available'}<br>`;
                    response += ` Power Outlets: ${Math.random() > 0.3 ? ' Available' : ' Limited'}<br>`;
                    response += ` Noise Level: ${['Quiet', 'Moderate', 'Lively'][Math.floor(Math.random() * 3)]}<br>`;
                    response += ` Seating: ${['Comfortable booths', 'Community tables', 'Window seats'][Math.floor(Math.random() * 3)]}<br><br>`;
                    
                } else if (type === 'hospital') {
                    const distance = (Math.random() * 5 + 0.5).toFixed(1);
                    
                    response += `<strong> Hospital Information:</strong><br>`;
                    response += ` <strong>Distance:</strong> ${distance} km from your location<br>`;
                    response += ` <strong>Emergency Services:</strong>  Available 24/7<br>`;
                    response += ` <strong>Est. Wait Time:</strong> ${15 + Math.floor(Math.random() * 45)} minutes<br><br>`;
                    
                    response += `<strong> Departments:</strong><br>`;
                    const depts = ['Emergency Room', 'General Medicine', 'Surgery', 'Pediatrics', 'Cardiology', 'Orthopedics', 'Radiology'];
                    depts.slice(0, 5).forEach(d => response += ` ${d}<br>`);
                    response += `<br>`;
                    
                    response += `<strong> Emergency Contact:</strong> (555) 123-4567<br><br>`;
                    response += `<small style="color: #ef4444;"> <strong>For life-threatening emergencies, call 911 immediately</strong></small><br><br>`;
                    
                } else if (type === 'pharmacy') {
                    const is24hr = Math.random() > 0.6;
                    
                    response += `<strong> Pharmacy Information:</strong><br>`;
                    
                    if (is24hr) {
                        response += ` <strong style="color: #10b981;">Open 24 Hours</strong><br><br>`;
                    } else {
                        response += ` <strong>Hours:</strong> 8:00 AM - 10:00 PM<br>`;
                        response += ` <strong>Status:</strong> ${Math.random() > 0.3 ? ' Currently Open' : ' Currently Closed'}<br><br>`;
                    }
                    
                    response += `<strong> Services Available:</strong><br>`;
                    response += ` Prescription Filling<br>`;
                    response += ` Flu Shots & Vaccinations<br>`;
                    response += ` Health Consultations<br>`;
                    response += ` OTC Medications<br>`;
                    response += ` Medical Supplies<br><br>`;
                }
                
                // Comparison with similar services
                if (similarCount > 0) {
                    response += `<div style="background: #f8fafc; padding: 12px; border-radius: 8px; margin-top: 12px;">`;
                    response += `<strong> Area Comparison:</strong><br>`;
                    response += `I found <strong>${similarCount}</strong> other ${type}${similarCount > 1 ? 's' : ''} nearby. `;
                    
                    const comparisons = [
                        'This location is highly rated among the options',
                        'This is one of the top-rated choices in the area',
                        'This location offers great value',
                        'This is a popular choice for visitors'
                    ];
                    response += comparisons[Math.floor(Math.random() * comparisons.length)] + '. ';
                    
                    const distances = [
                        'It\'s centrally located and easily accessible',
                        'Convenient location with good accessibility',
                        'Well-positioned in the area'
                    ];
                    response += distances[Math.floor(Math.random() * distances.length)] + '.';
                    response += `</div><br>`;
                }
                
                // Action buttons
                response += `<div class="ai-action-buttons">`;
                response += `<button class="ai-action-btn" onclick="app.getDirections(${service.coordinates.lat}, ${service.coordinates.lng})">`;
                response += `<i class="fas fa-directions"></i> Navigate Here`;
                response += `</button>`;
                
                if (type === 'hotel') {
                    response += `<button class="ai-action-btn" onclick="alert('Booking feature coming soon!')">`;
                    response += `<i class="fas fa-calendar-check"></i> Book Now`;
                    response += `</button>`;
                } else if (type === 'restaurant') {
                    response += `<button class="ai-action-btn" onclick="alert('Reservation feature coming soon!')">`;
                    response += `<i class="fas fa-utensils"></i> Reserve Table`;
                    response += `</button>`;
                } else if (type === 'hospital') {
                    response += `<button class="ai-action-btn" onclick="alert('Calling hospital...')">`;
                    response += `<i class="fas fa-phone"></i> Call Now`;
                    response += `</button>`;
                }
                
                response += `</div><br>`;
                
                response += `<small style="color: #94a3b8; font-size: 11px;"> This information is simulated. In production, real-time data would come from Google Places, Yelp, and Booking.com APIs.</small>`;
                
                this.addAIMessage('bot', response);
            },

            // ===== UTILITIES =====
            getNextColor: function() {
                return this.state.colors[this.state.layerCounter % this.state.colors.length];
            },

            toast: function(message) {
                const toast = document.getElementById('toast');
                toast.textContent = message;
                toast.classList.add('show');
                
                setTimeout(() => {
                    toast.classList.remove('show');
                }, 3000);
            }
        };

        // Initialize app
        app.init();
    </script>
</body>
</html>
